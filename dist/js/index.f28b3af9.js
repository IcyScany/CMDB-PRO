import{_ as e}from"./ServerTable.53881589.js";import{a3 as t,al as a,r as l,a0 as u,O as o,Q as s,U as i,W as r,c as d,$ as n,R as m,F as _,S as p,ad as f,ah as v,Y as c,Z as y,b5 as h,cZ as b,aj as k,cH as w,aY as g,a8 as S,aN as Y,a9 as x,aa as D,X as j,dC as H,H as U,a6 as T,J as M,q as C,dP as O,v as A,d2 as E}from"./index.872a2bd0.js";import{s as $}from"./scheduledTasksApi.721351f3.js";import{o as R,c as N,_ as F,u as I}from"./opsFormInit.3a4e1794.js";import{a as L,_ as P}from"./index.029351cd.js";import{_ as q}from"./index.90e0ec19.js";import{h as z}from"./moment.39d4ecb7.js";import{D as B}from"./dayjs.c124633a.js";import{S as V,_ as G}from"./index.44a4e190.js";import{_ as J}from"./index.fe8e77ef.js";import{t as Z}from"./tableRender.a6ff99b7.js";import"./index.2c670fa1.js";import"./index.6f715054.js";import"./useBreakpoint.e81952b0.js";import"./index.e3d002e2.js";import"./index.fc9664cf.js";import"./index.9846e408.js";import"./index.65b2e021.js";import"./index.6e2fd079.js";import"./Group.b415afa6.js";import"./Checkbox.ddee6d58.js";import"./RadioButton.534ff50d.js";import"./index.48209b21.js";import"./index.64f8d8d4.js";import"./alertLevel.8dae0e72.js";const K=e=>(x("data-v-5c7658f0"),e=e(),D(),e),Q=K((()=>j("span",{class:"text-warning"},"选择开始和结束时间后，任务会在此时间段执行，不选择为一直执行",-1))),W=K((()=>j("span",{class:"text-warning"},"选择开始和结束时间后，任务会在此时间段执行，不选择为一直执行",-1))),X=t({__name:"edit",props:{open:{type:Boolean,default:!1},sid:{type:[String,Number],default:""},formType:{type:Number}},emits:["update:open","editSuccess"],setup(e,{emit:t}){const x=e,{open:D,sid:j,formType:U}=a(x),T=t;let M=l(null);const{postScheduledTasksAdd:C,putScheduledTasksEdit:O,getScheduledTasksList:A}=$,E={interval:{days:0,hours:0,weeks:0,minutes:0,seconds:0,end_date:null,start_date:null},cron:{year:"",month:[],day:[],week:[],day_of_week:[],hour:[],minute:[],second:[],start_date:null,end_date:null},date:{run_date:""}},I=l(0),Z=l("weeks"),K={weeks:"周",days:"天",hours:"时",minutes:"分",seconds:"秒"},X=()=>{Object.keys(K).forEach((e=>{ee.value[se.value.formState.run_time_type][e]=0}))},ee=l(u.clone(E,!0)),te=[{label:"星期一",value:1},{label:"星期二",value:2},{label:"星期三",value:3},{label:"星期四",value:4},{label:"星期五",value:5},{label:"星期六",value:6},{label:"星期日",value:0}],ae=[{key:"other",tab:"其它"},{key:"week",tab:"按周"}],le=e=>e&&e<z().endOf("day"),ue=l("other"),oe=e=>{ue.value=e,ee.value.cron=u.clone(E.cron,!0)};let{formRenderContent:se,formDataLoading:ie,confirmLoading:re,initForm:de,formDataInit:ne,editSubmit:me}=R({formRef:M,editTitleLayer:1,formType:U,sid:j,addApi:C,editApi:O,oneDataApi:A,customSubmitData:async e=>{if(e.run_time_type){e.run_time=u.clone(ee.value[e.run_time_type],!0),"interval"===e.run_time_type&&(e.run_time[Z.value]=I.value);for(let a in e.run_time)a.indexOf("_date")>-1&&e.run_time[a]&&(e.run_time[a]=(t=e.run_time[a],H(t).format("YYYY-MM-DD HH:mm:ss"))),Array.isArray(e.run_time[a])&&(e.run_time[a]=e.run_time[a].length?e.run_time[a].join(","):null),"year"===a&&(e.run_time[a]=e.run_time[a]?e.run_time[a].format("YYYY"):null)}var t;for(let a in e)0===e[a]||!1===e[a]||e[a]||(e[a]=null);return e},customOneData:e=>{var t;let a=u.clone(e.value,!0),l=a.run_time_type;if(a&&l){let e=a.run_time;if(ue.value=(null==(t=null==e?void 0:e.run_time)?void 0:t.day_of_week)?"week":"other",e){let t=u.clone(e,!0);"interval"===l&&(Z.value=Object.keys(t).find((e=>t[e])),I.value=t[Z.value]);for(let e in t)t[e]&&(ee.value[l][e]=Array.isArray(ee.value[l][e])?t[e].split(",").map((e=>Number(e))):e.indexOf("_date")>-1&&t[e]||"year"===e?H(t[e]):t[e])}}},emits:T});const _e=()=>{T("update:open",!1)},pe=async e=>{e&&(ee.value=u.clone(E,!0),await de(),await ne(),U.value===h&&(se.value.formState.run_time={},I.value=0,Z.value="weeks"))};return(e,t)=>{const a=N,l=V,u=G,h=b,x=L,j=k,H=B,T=w,C=g,O=J,A=F,E=q,$=S,R=Y,de=o("vxe-button"),ne=P;return s(),i(ne,{title:`${e.$route.meta.title}${n(U)===e.$CONFIG.FORM_TYPE.ADD_TYPE?"新增":"编辑"}`,open:n(D),onAfterOpenChange:pe,onClose:_e},{footer:r((()=>[d(de,{content:"取消",onClick:_e}),d(de,{type:"submit",loading:n(re),status:"primary",content:"提交",onClick:n(me)},null,8,["loading","onClick"])])),default:r((()=>[d(R,{spinning:n(ie)},{default:r((()=>[d($,{ref_key:"formRef",ref:M,model:n(se).formState,rules:n(se).rules,"label-col":{span:4},"label-align":"left",colon:!1},{default:r((()=>[(s(!0),m(_,null,p(e.$utils.filter(n(se).title,(e=>e.edit_display)),(e=>{var o,b,k,w,g,S;return s(),m(_,{key:e.field},["run_time"===e.field?(s(),m(_,{key:0},[n(se).formState.run_time_type?(s(),i(A,{key:0,value:n(se).formState[e.field],"onUpdate:value":t=>n(se).formState[e.field]=t,title:e,class:"run-time-form","title-data":null==(b=null==(o=n(se))?void 0:o.title_data)?void 0:b[e.field]},{default:r((()=>["interval"===n(se).formState.run_time_type?(s(),i(C,{key:0},{default:r((()=>[d(T,null,{default:r((()=>[d(x,{align:"start",style:{width:"100%"},class:"border-2 border-b-blue-300 bottom-1"},{default:r((()=>[d(h,{block:""},{default:r((()=>[d(a,{value:n(I),"onUpdate:value":t[0]||(t[0]=e=>f(I)?I.value=e:null),min:0,style:{width:"70%"}},null,8,["value"]),d(u,{value:n(Z),"onUpdate:value":t[1]||(t[1]=e=>f(Z)?Z.value=e:null),style:{width:"30%"},onChange:X},{default:r((()=>[(s(),m(_,null,p(K,((e,t)=>d(l,{key:t,label:e,value:t},{default:r((()=>[v(c(e),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1})])),_:1}),d(x,{style:{width:"100%",margin:"5px 0"}},{default:r((()=>[d(h,{block:""},{default:r((()=>[d(j,{style:{width:"30%"},disabled:"",placeholder:"开始日期"}),d(H,{value:n(ee)[n(se).formState.run_time_type].start_date,"onUpdate:value":t[2]||(t[2]=e=>n(ee)[n(se).formState.run_time_type].start_date=e),format:"YYYY-MM-DD HH:mm:ss","show-time":{defaultValue:n(z)("00:00:00","HH:mm:ss")},style:{width:"70%"}},null,8,["value","show-time"])])),_:1})])),_:1}),d(x,{style:{width:"100%"}},{default:r((()=>[d(h,{block:""},{default:r((()=>[d(j,{style:{width:"30%"},disabled:"",placeholder:"结束日期"}),d(H,{value:n(ee)[n(se).formState.run_time_type].end_date,"onUpdate:value":t[3]||(t[3]=e=>n(ee)[n(se).formState.run_time_type].end_date=e),format:"YYYY-MM-DD HH:mm:ss","show-time":{defaultValue:n(z)("00:00:00","HH:mm:ss")},style:{width:"70%"}},null,8,["value","show-time"])])),_:1})])),_:1}),Q])),_:1})])),_:1})):y("",!0),"cron"===n(se).formState.run_time_type?(s(),i(C,{key:1,"tab-list":ae,"active-tab-key":n(ue),onTabChange:oe},{default:r((()=>[d(T,null,{default:r((()=>[d(x,{align:"start",style:{"flex-direction":"column",width:"100%"},class:"border-2 border-b-blue-300"},{default:r((()=>["other"===n(ue)?(s(),m(_,{key:0},[d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"年"}),d(H,{value:n(ee)[n(se).formState.run_time_type].year,"onUpdate:value":t[4]||(t[4]=e=>n(ee)[n(se).formState.run_time_type].year=e),"disabled-date":le,style:{width:"90%"},format:"YYYY",picker:"year"},null,8,["value"])])),_:1}),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"月"}),d(u,{value:n(ee)[n(se).formState.run_time_type].month,"onUpdate:value":t[5]||(t[5]=e=>n(ee)[n(se).formState.run_time_type].month=e),"allow-clear":"","auto-clear-search-value":"",style:{width:"90%"},mode:"multiple"},{default:r((()=>[(s(),m(_,null,p(12,(e=>d(l,{key:e,label:e,value:e},{default:r((()=>[v(c(e),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1}),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"日"}),d(u,{value:n(ee)[n(se).formState.run_time_type].day,"onUpdate:value":t[6]||(t[6]=e=>n(ee)[n(se).formState.run_time_type].day=e),mode:"multiple",style:{width:"90%"}},{default:r((()=>[(s(),m(_,null,p(31,(e=>d(l,{key:e,label:e,value:e},{default:r((()=>[v(c(e),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1}),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"周"}),d(u,{value:n(ee)[n(se).formState.run_time_type].week,"onUpdate:value":t[7]||(t[7]=e=>n(ee)[n(se).formState.run_time_type].week=e),mode:"multiple",style:{width:"90%"}},{default:r((()=>[(s(),m(_,null,p(53,(e=>d(l,{key:e,label:e,value:e},{default:r((()=>[v(c(e),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1})],64)):y("",!0),"week"===n(ue)?(s(),i(h,{key:1,block:""},{default:r((()=>[d(O,{value:n(ee)[n(se).formState.run_time_type].day_of_week,"onUpdate:value":t[8]||(t[8]=e=>n(ee)[n(se).formState.run_time_type].day_of_week=e),options:te},null,8,["value"])])),_:1})):y("",!0),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"时"}),d(u,{value:n(ee)[n(se).formState.run_time_type].hour,"onUpdate:value":t[9]||(t[9]=e=>n(ee)[n(se).formState.run_time_type].hour=e),mode:"multiple",style:{width:"90%"}},{default:r((()=>[(s(),m(_,null,p(24,((e,t)=>d(l,{key:e,label:t,value:t},{default:r((()=>[v(c(t),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1}),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"分"}),d(u,{value:n(ee)[n(se).formState.run_time_type].minute,"onUpdate:value":t[10]||(t[10]=e=>n(ee)[n(se).formState.run_time_type].minute=e),mode:"multiple",style:{width:"90%"}},{default:r((()=>[(s(),m(_,null,p([0,5,10,15,20,25,30,35,40,45,50,55],(e=>d(l,{key:e,label:e,value:e},{default:r((()=>[v(c(e),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1}),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"10%"},disabled:"",placeholder:"秒"}),d(u,{value:n(ee)[n(se).formState.run_time_type].second,"onUpdate:value":t[11]||(t[11]=e=>n(ee)[n(se).formState.run_time_type].second=e),mode:"multiple",style:{width:"90%"}},{default:r((()=>[(s(),m(_,null,p(60,((e,t)=>d(l,{key:e,label:t,value:t},{default:r((()=>[v(c(t),1)])),_:2},1032,["label","value"]))),64))])),_:1},8,["value"])])),_:1}),d(h,{block:""},{default:r((()=>[d(j,{style:{width:"15%"},disabled:"",placeholder:"开始日期"}),d(H,{value:n(ee)[n(se).formState.run_time_type].start_date,"onUpdate:value":t[12]||(t[12]=e=>n(ee)[n(se).formState.run_time_type].start_date=e),format:"YYYY-MM-DD HH:mm:ss","show-time":{defaultValue:n(z)("00:00:00","HH:mm:ss")},style:{width:"35%"}},null,8,["value","show-time"]),d(j,{style:{width:"15%"},disabled:"",placeholder:"结束日期"}),d(H,{value:n(ee)[n(se).formState.run_time_type].end_date,"onUpdate:value":t[13]||(t[13]=e=>n(ee)[n(se).formState.run_time_type].end_date=e),format:"YYYY-MM-DD HH:mm:ss","show-time":{defaultValue:n(z)("00:00:00","HH:mm:ss")},style:{width:"35%"}},null,8,["value","show-time"])])),_:1}),W])),_:1})])),_:1})])),_:1},8,["active-tab-key"])):y("",!0),"date"===n(se).formState.run_time_type?(s(),i(H,{key:2,value:n(ee)[n(se).formState.run_time_type].run_date,"onUpdate:value":t[14]||(t[14]=e=>n(ee)[n(se).formState.run_time_type].run_date=e),format:"YYYY-MM-DD HH:mm:ss","show-time":{defaultValue:n(z)("00:00:00","HH:mm:ss")}},null,8,["value","show-time"])):y("",!0)])),_:2},1032,["value","onUpdate:value","title","title-data"])):y("",!0)],64)):"output_keyword"===e.field?(s(),i(A,{key:1,value:n(se).formState[e.field],"onUpdate:value":t=>n(se).formState[e.field]=t,title:e,"title-data":null==(w=null==(k=n(se))?void 0:k.title_data)?void 0:w[e.field]},{default:r((()=>[d(E,{tags:n(se).formState[e.field],"onUpdate:tags":t=>n(se).formState[e.field]=t,editable:!0},null,8,["tags","onUpdate:tags"])])),_:2},1032,["value","onUpdate:value","title","title-data"])):(s(),i(A,{key:2,value:n(se).formState[e.field],"onUpdate:value":t=>n(se).formState[e.field]=t,title:e,"title-data":null==(S=null==(g=n(se))?void 0:g.title_data)?void 0:S[e.field]},null,8,["value","onUpdate:value","title","title-data"]))],64)})),128))])),_:1},8,["model","rules"])])),_:1},8,["spinning"])])),_:1},8,["title","open"])}}},[["__scopeId","data-v-5c7658f0"]]),ee=e=>(x("data-v-7494c28d"),e=e(),D(),e),te={class:"my-2"},ae=ee((()=>j("b",null,"开始时间：",-1))),le=ee((()=>j("b",null,"结束时间：",-1))),ue=ee((()=>j("b",null,"执行时间：",-1))),oe={style:{"margin-left":"30px"}},se={class:"cmd-style"},ie={key:0,class:"end-box"},re=t({__name:"index",props:{logData:{type:Object,default:()=>({})},open:{type:Boolean,default:!1}},emits:["update:open"],setup(e,{emit:t}){const a=e,u=t,o=l(null),f=U({loading:!1,data:[],log_timestamp:Math.floor(Date.now()/1e3)}),h=async()=>{-1===f.log_timestamp||f.loading||(f.loading=!0,$.getLogList(a.logData.id,f.log_timestamp).then((e=>{f.loading=!1,e.param.length?(f.log_timestamp=e.param[0]._source.timestamp,f.data.push(...e.param),o.value.scrollHeight<=o.value.parentNode.clientHeight&&h()):f.log_timestamp=-1})).catch((()=>{f.loading=!1,f.log_timestamp=-1})))},b=e=>{let t=e.target.scrollHeight-e.target.scrollTop-e.target.clientHeight;Math.floor(t)<=0&&-1!==f.log_timestamp&&h()},k=(e,t=!0)=>{let a=["年","月","周","天","小时","分","秒"],l=[31104e6,2592e6,6048e5,864e5,36e5,6e4,1e3],u=e+" 毫秒",o=e;for(let i in l)if(e>=l[i]){let t=parseInt(e/l[i]);o=t*l[i],u=`${t} ${a[i]}`;break}let s=e-o?k(e-o):"";return`${u}${t?s:""}`},w=e=>{e?h():(f.data=[],f.log_timestamp=Math.floor(Date.now()/1e3))};return(t,a)=>{const l=Y,h=P;return s(),i(h,{open:e.open,title:"定时任务日志","onUpdate:open":a[0]||(a[0]=e=>u("update:open",e)),onAfterOpenChange:w},{default:r((()=>[j("div",null,[j("div",null,"定时任务日志查看 IP: "+c(e.logData.run_address),1),j("div",te,"命令: "+c(e.logData.run_command),1)]),d(l,{spinning:n(f).loading,size:"large"},{default:r((()=>[j("div",{ref_key:"listContentRef",ref:o,class:"list-box",onScroll:b},[(s(!0),m(_,null,p(n(f).data,(e=>(s(),m("div",{key:e._id},[j("div",{class:T([e._source.status?"bg-gradient-success":"bg-gradient-danger","py-1"])},[ae,v(c(n(z)(1e3*e._source.timestamp).format("YYYY-MM-DD HH:mm:ss"))+" ",1),le,v(c(n(z)(1e3*e._source.stop_time).format("YYYY-MM-DD HH:mm:ss"))+" ",1),ue,v(c(k(1e3*(e._source.stop_time-e._source.timestamp)))+" ",1),j("span",oe,"状态码：("+c(e._source.status)+")",1)],2),j("pre",se,c(e._source.task_log),1)])))),128))],544)])),_:1},8,["spinning"]),-1===n(f).log_timestamp?(s(),m("div",ie," END ")):y("",!0)])),_:1},8,["open"])}}},[["__scopeId","data-v-7494c28d"]]),de={style:{"font-size":"12px","white-space":"pre"}},ne=j("span",{class:"text-primary"},"执行时间",-1),me={key:2},_e={__name:"index",setup(t){const a=l([]),u=l([]),p=l({}),y=l([]),h=l(null),b=l({}),k=l(!1),w=l({}),g=l([]);M((async()=>{let{title_data:e,order:t,button:l,columns:o,title_field_search:s}=await Z.setColumn({layer:1,tableType:"server"});a.value=(null==o?void 0:o.value)||[],u.value=l.value,p.value=e.value,y.value=s.value||[],b.value=t.value?t.value:{},await x()}));const S=C((()=>{for(let e of a.value){let{field:t}=e;switch(t){case"run_time":case"run_time_type":case"keyword_success":case"last_task_result":e.slots={default:t};break;case"virtual_team_v3_id":e.showOverflow=!1}}return a.value}));let Y=C((()=>{let e={};if(u.value)for(let t of u.value){let{field:a}=t;switch(a){case"edit":case"add":e[a]=t;break;case"delete":e.del=t}}return e}));const x=async()=>{h.value.gridOption.proxyConfig.ajax.querySuccess=({response:e})=>{g.value=(null==e?void 0:e.last_task_result)||[]},h.value&&h.value.serverTableRef.commitProxy("query")},D=C((()=>({fields:[{field:"name",operator:"vague"}],placeholder:"支持任务名称快速搜索"}))),{userDel:H,userEdit:U,formOpen:T,formType:R,formSid:N}=I(),F=({type:e,row:t})=>{U({type:e,sid:t.id})},L=({row:e})=>{H({sid:e.id,delApi:$.delScheduledTasks,loadData:x})};return(t,a)=>{const l=A,u=o("vxe-tag"),H=E,M=e;return s(),m(_,null,[d(M,{ref_key:"serverTableRef",ref:h,"table-column":n(S),"auth-btn":n(Y),order:n(b),"query-api":n($).postScheduledTasksList,"switch-click-status-config":{api:n($).putScheduledTasksEdit},"title-field-search":n(y),"default-search-field":n(D),"is-show-doc":!0,"show-env-search":{app_name:"scheduled_tasks"},onUserEdit:F,onUserAdd:a[0]||(a[0]=e=>{n(U)({type:t.$CONFIG.FORM_TYPE.ADD_TYPE})}),onUserDel:L},{run_time:r((({row:e})=>[d(l,null,{title:r((()=>[j("div",de,c(JSON.stringify(e.run_time,null,4)),1)])),default:r((()=>[ne])),_:2},1024)])),run_time_type:r((({row:e})=>{var t,a;return[v(c(null==(a=null==(t=n(p))?void 0:t.run_time_type)?void 0:a[null==e?void 0:e.run_time_type]),1)]})),keyword_success:r((({row:e})=>[e.keyword_success?(s(),i(u,{key:0,class:"theme--primary",size:"small"},{default:r((()=>[v(c("成功"))])),_:1})):null!==e.keyword_success?(s(),i(u,{key:1,class:"theme--error",size:"small"},{default:r((()=>[v(c("失败"))])),_:1})):(s(),m("span",me))])),other_operation:r((({row:e})=>[d(l,{title:"查看日志"},{default:r((()=>[d(n(O),{class:"text-primary cursor-pointer text-[14px]",onClick:t=>(e=>{k.value=!0,w.value=e})(e)},null,8,["onClick"])])),_:2},1024)])),last_task_result:r((({row:e})=>{var t,a;return[d(H,{value:null==(a=null==(t=n(g))?void 0:t.find((t=>t.id==(null==e?void 0:e.id))))?void 0:a.res,"active-value":"成功"},null,8,["value"])]})),_:1},8,["table-column","auth-btn","order","query-api","switch-click-status-config","title-field-search","default-search-field"]),d(X,{open:n(T),"onUpdate:open":a[1]||(a[1]=e=>f(T)?T.value=e:null),sid:n(N),"form-type":n(R),onEditSuccess:x},null,8,["open","sid","form-type"]),d(re,{open:n(k),"onUpdate:open":a[2]||(a[2]=e=>f(k)?k.value=e:null),"log-data":n(w)},null,8,["open","log-data"])],64)}}};export{_e as default};
