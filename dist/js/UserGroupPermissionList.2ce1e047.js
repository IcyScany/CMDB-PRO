import{aR as e,a3 as l,al as t,r as i,H as a,J as n,a0 as s,b0 as o,O as u,Q as d,R as r,c,W as v,ah as y,$ as k,U as p,F as m,S as f,Y as h,ad as _,ag as b,X as g,am as $,Z as x,a6 as C,C as w,D as U,ai as j,b1 as L,ak as G,aN as P,aY as E,aw as B,au as A,v as R,ax as S,a9 as V,aa as z}from"./index.872a2bd0.js";import{s as D}from"./successModal.c280f18f.js";import{t as M}from"./tableRender.a6ff99b7.js";import"./index.6e2fd079.js";import{R as O,_ as T}from"./Group.b415afa6.js";import{C as F}from"./index.fe8e77ef.js";import{_ as Y}from"./index.44a4e190.js";import"./alertLevel.8dae0e72.js";import"./RadioButton.534ff50d.js";import"./Checkbox.ddee6d58.js";const q="system/user-group/",H={getUserGroupPermissionsList:l=>e.get(`${q}permissions${l?`/${l}`:""}`),getUserGroupUserList:(l,t)=>e.get(`${q}user/list${l||""}`,t),putUserGroupPermissionEdit:(l,t)=>e.put(`${q}permissions/${l}`,t),patchUserGroupUserPermissionEdit:(l,t)=>e.patch(`${q}permissions/user/edit/${l}`,t)},I=e=>(V("data-v-a5b62e27"),e=e(),z(),e),J=I((()=>g("b",{class:"vxe-icon-company"},null,-1))),N=I((()=>g("b",{class:"vxe-icon-envelope"},null,-1))),Q=I((()=>g("b",{class:"vxe-icon-mobile"},null,-1))),W=I((()=>g("b",{class:"vxe-icon-company"},null,-1))),X={class:"part-content-box"},Z={class:"m1-content-box"},K=["onClick"],ee={class:"m2-content-box"},le={class:"layer-box"},te=I((()=>g("b",{class:"text-error bold-class-btn"},"B",-1))),ie="system/user-group/",ae=l({__name:"UserGroupPermissionList",props:{sid:{type:String,default:""}},setup(l){const V=l,{sid:z}=t(V),q=`${ie}permissions`;let I=i({}),{getCommonBusinessList:ae}=j,ne=i({loading:!1,list:[],error:""}),se=i(null),oe=i([]);const{business_data:ue,requestBusinessData:de}=ae();let re=i([]),ce=i(!1);const ve={menu:[],title:[],layer:[]};let ye=i(ve);const ke=({key:e,type:l,checked:t})=>{let i=ye.value[l].indexOf(e);t||-1===i||ye.value[l].splice(i,1),-1!==i||!0!==t&&void 0!==t||ye.value[l].push(e)},pe=({key:e,level1:l,level2:t,type:i,layer:a,title:n,button:s,num:o,idx:u})=>{var d,r,c,v;ke({key:e,type:i});let y=ye.value[i].indexOf(e),k=null==(r=null==(d=re.value)?void 0:d[u])?void 0:r.menus;if(-1===y){if("layer"===i){for(let e of n)ke({key:e.sid,type:"title",checked:!1});for(let e of s)ke({key:e.sid,type:"title",checked:!1})}if("menu"===i&&2===o){let e=null==(c=null==k?void 0:k[t])?void 0:c.title_button;if(e)for(let i in e){let{title:a,button:n}=e[i];ke({key:`${l}_${t}_${i}`,type:"layer",checked:!1});for(let e of a)ke({key:e.sid,type:"title",checked:!1});for(let e of n)ke({key:e.sid,type:"title",checked:!1})}}if("menu"===i&&1===o){let e=k;if(e)for(let t in e){ke({key:1*t,type:"menu",checked:!1});let{title_button:i}=e[t];if(i)for(let e in i){let{title:a,button:n}=i[e];ke({key:`${l}_${1*t}_${e}`,type:"layer",checked:!1});for(let e of a)ke({key:e.sid,type:"title",checked:!1});for(let e of n)ke({key:e.sid,type:"title",checked:!1})}}}}else{if("title"===i&&(ke({key:l,type:"menu",checked:!0}),ke({key:t,type:"menu",checked:!0}),ke({key:`${l}_${t}_${a}`,type:"layer",checked:!0})),"layer"===i){ke({key:l,type:"menu",checked:!0}),ke({key:t,type:"menu",checked:!0});for(let e of n)ke({key:e.sid,type:"title",checked:!0});for(let e of s)ke({key:e.sid,type:"title",checked:!0})}if("menu"===i&&2===o){let e=null==(v=null==k?void 0:k[t])?void 0:v.title_button;if(ke({key:l,type:"menu",checked:!0}),e)for(let i in e){let{title:a,button:n}=e[i];ke({key:`${l}_${t}_${i}`,type:"layer",checked:!0});for(let e of a)ke({key:e.sid,type:"title",checked:!0});for(let e of n)ke({key:e.sid,type:"title",checked:!0})}}if("menu"===i&&1===o){let e=k;if(e)for(let t in e){ke({key:1*t,type:"menu",checked:!0});let{title_button:i}=e[t];if(i)for(let e in i){let{title:a,button:n}=i[e];ke({key:`${l}_${1*t}_${e}`,type:"layer",checked:!0});for(let e of a)ke({key:e.sid,type:"title",checked:!0});for(let e of n)ke({key:e.sid,type:"title",checked:!0})}}}}};let me=i({checkAll:!1,indeterminate:!1});const fe=()=>{me.value.checkAll=!me.value.checkAll,he(me.value.checkAll)},he=e=>{let l=re.value;if(l)for(let t of l){let{sid:l,menus:i}=t;ke({key:l,type:"menu",checked:e});for(let t in i){ke({key:1*t,type:"menu",checked:e});let{title_button:a}=i[t];if(a)for(let i in a){let{title:n,button:s}=a[i];ke({key:`${l}_${1*t}_${i}`,type:"layer",checked:e});for(let l of n)ke({key:l.sid,type:"title",checked:e});for(let l of s)ke({key:l.sid,type:"title",checked:e})}}}};let _e=i(!1),be=i(!1);const ge=()=>{se.value&&(_e.value=!0,be.value=!0,e.put(`${q}/edit/${se.value}`,{title_sid:ye.value.title,menu_sid:ye.value.menu}).then((e=>{be.value=!1,_e.value=!1,D({title:null==e?void 0:e.msg}),$e()})).catch((()=>{be.value=!1,_e.value=!1})))},$e=()=>{ye.value={menu:[],title:[],layer:[]},se.value&&(be.value=!0,H.getUserGroupPermissionsList(se.value).then((e=>{ye.value=e||ve,ye.value.menu=null==e?void 0:e.menu_sid,ye.value.title=null==e?void 0:e.title_sid,ye.value.layer=[],be.value=!1,je()})).catch((()=>{be.value=!1})))},xe=a({data:[],current_val:null,fetching:!1});let Ce=0;const we=e=>{let l=e&&(s.isValidMobilePhone(e)||s.isValidEmail(e))?`?search=${e}`:"";Ce+=1;const t=Ce;xe.data=null,xe.fetching=!0,H.getUserGroupUserList(l,{noErrorTip:!0}).then((e=>{if(t!==Ce)return;const l=e.map((e=>{var l,t,i;let{email:a,username:n,mobile:s,id:o,business_id:u}=e||{};return{label:`${n} - ${a} - (Phone: ${s}) ${null==(i=null==(t=null==(l=ue.value)?void 0:l.data)?void 0:t[u])?void 0:i.business}`,value:o,origin:e}}));xe.data=l,xe.fetching=!1}))};let Ue=i(!1);const je=()=>{se.value&&(oe.value=[],Ue.value=!0,H.getUserGroupUserList(`/${se.value}`).then((e=>{oe.value=e,Ue.value=!1})).catch((()=>{Ue.value=!1})))},Le=(l,t)=>{e.patch(`${q}/user/edit/${se.value}`,{user_sid:l,action:t}).then((e=>{"add"===t&&(xe.current_val=null),L.success(e.msg),je()}))};let Ge=i([]);const Pe=i({});n((async()=>{await(async()=>{ne.value.loading=!0,await e.get(`${ie}list`,{noErrorTip:!0}).then((e=>{ne.value.list=e,ne.value.loading=!1})).catch((e=>{var l,t,i,a;let n=null==(l=null==e?void 0:e.response)?void 0:l.status;ne.value.error=(null==(t=null==e?void 0:e.response)?void 0:t.message)||(null==(a=null==(i=null==e?void 0:e.response)?void 0:i.data)?void 0:a.msg)+`【${n}】`,ne.value.loading=!1})),se.value=z.value,$e()})(),re.value={},ce.value=!0,e.get(q).then((e=>{re.value=(null==e?void 0:e.data)?e.data:[],ce.value=!1})).catch((()=>{ce.value=!1})),await de(),we();let{button:l}=await M.getTitle({layer:1});Ge.value=l;for(let e of l.value)Pe.value[e.field]=e}));const Ee=s.debounce((async e=>{if(!(e=e.trim()))return void we();const l=await o.isValidMobilePhone(e),t=await o.isValidEmail(e);l||t?we(e):xe.fetching=!1}),300),Be=(e,l)=>!e||l.label.toLowerCase().includes(e.toLowerCase());return(e,l)=>{var t,i;const a=O,n=T,o=G,j=P,L=E,V=Y,z=u("vxe-button"),D=B,M=A,q=R,H=S,ie=F,ae=u("vxe-tag");return d(),r(m,null,[c(L,{hoverable:""},{title:v((()=>[y(" 组名 ")])),default:v((()=>[c(j,{spinning:k(ne).loading},{default:v((()=>{var e,t,i;return[k(ne)&&(null==(e=k(ne))?void 0:e.list)&&(null==(t=k(ne))?void 0:t.list.length)?(d(),p(n,{key:0,value:k(se),"onUpdate:value":l[0]||(l[0]=e=>_(se)?se.value=e:se=e),name:"id",onChange:$e},{default:v((()=>[(d(!0),r(m,null,f(k(ne).list,(e=>(d(),p(a,{key:e.id,value:e.id.toString()},{default:v((()=>[y(h(e.group_name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value","onChange"])):(d(),p(o,{key:1},b({_:2},[(null==(i=k(ne))?void 0:i.error)?{name:"description",fn:v((()=>[])),key:"0"}:void 0]),1024))]})),_:1},8,["spinning"])])),_:1}),c(L,{loading:k(Ue),hoverable:""},{title:v((()=>{var e,t;return[y(" 用户 "),c(V,{value:xe.current_val,"onUpdate:value":l[1]||(l[1]=e=>xe.current_val=e),"show-search":"","label-in-value":"","allow-clear":"",placeholder:"支持用户名模糊搜索，手机号、邮箱精确搜索",style:{width:"50%","margin-right":"2px"},"filter-option":Be,"not-found-content":xe.fetching?void 0:null,options:xe.data,onSearch:k(Ee)},b({option:v((({origin:e})=>{var l,t,i,a,n,s;return[g("span",{class:"custom-item",style:$({color:null==(i=null==(t=null==(l=k(ue))?void 0:l.data)?void 0:t[null==e?void 0:e.business_id])?void 0:i.theme})},[J,y(": "+h((null==(s=null==(n=null==(a=k(ue))?void 0:a.data)?void 0:n[null==e?void 0:e.business_id])?void 0:s.business)||(null==e?void 0:e.business_id))+" -> "+h(e.username)+" (",1),N,y(": "+h(null==e?void 0:e.email)+" ",1),Q,y(": "+h(null==e?void 0:e.mobile)+" )",1)],4)]})),_:2},[xe.fetching?{name:"notFoundContent",fn:v((()=>[c(j,{size:"small"})])),key:"0"}:void 0]),1032,["value","not-found-content","options","onSearch"]),(null==(t=null==(e=Pe.value)?void 0:e.permissions_user_edit)?void 0:t.page_display)?(d(),p(z,{key:0,content:"添加用户",disabled:!xe.current_val,status:"primary",size:"mini",onClick:l[2]||(l[2]=e=>Le(xe.current_val.value,"add"))},null,8,["disabled"])):x("",!0)]})),default:v((()=>[k(oe).length?(d(!0),r(m,{key:0},f(k(s.groupBy)(k(oe),"business_id"),((e,l)=>(d(),p(H,{key:l,type:"flex",class:"mb-2"},{default:v((()=>[c(D,{flex:"10rem"},{default:v((()=>{var e,t,i;return[W,y(h(null==(i=null==(t=null==(e=k(ue))?void 0:e.data)?void 0:t[l])?void 0:i.business),1)]})),_:2},1024),c(D,{flex:"auto"},{default:v((()=>[(d(!0),r(m,null,f(e,(e=>(d(),p(q,{key:e.id},{title:v((()=>[g("p",null,"邮箱："+h(e.email),1),g("p",null,"手机号："+h(e.mobile),1)])),default:v((()=>{var l,t,i;return[c(M,{color:null==(i=null==(t=null==(l=k(ue))?void 0:l.data)?void 0:t[e.business_id])?void 0:i.theme,closable:"",onClose:l=>Le(e.id,"del")},{default:v((()=>[y(h(e.username),1)])),_:2},1032,["color","onClose"])]})),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128)):(d(),p(o,{key:1}))])),_:1},8,["loading"]),c(L,{bordered:!1,title:"菜单选项",class:"part-box"},{default:v((()=>[c(ie,{checked:k(me).checkAll,indeterminate:k(me).indeterminate,onClick:fe},{default:v((()=>[y(" 全选 ")])),_:1},8,["checked","indeterminate"]),g("div",X,[c(j,{spinning:k(be)},{default:v((()=>[k(re)?(d(!0),r(m,{key:0},f(k(re),((e,l)=>(d(),r(m,{key:e.sid},[c(ie,{checked:k(ye).menu.includes(e.sid),onClick:t=>pe({key:e.sid,type:"menu",num:1,idx:l,level1:e.sid})},{default:v((()=>[g("h3",null,h(null==e?void 0:e.menu_name),1)])),_:2},1032,["checked","onClick"]),g("div",Z,[(d(!0),r(m,null,f(e.menus,((t,i)=>(d(),r(m,{key:i},[g("div",null,[g("i",{class:C([k(I)[i]?"vxe-icon-arrow-down":"vxe-icon-arrow-up","m2-expand-icon","text-info"]),onClick:e=>k(I)[i]=!k(I)[i]},null,10,K),c(ie,{checked:k(ye).menu.includes(1*i),onClick:t=>pe({key:1*i,type:"menu",level1:e.sid,level2:i,num:2,idx:l})},{default:v((()=>[g("h4",null,[c(ae,{class:"theme--primary"},{default:v((()=>[y(h(null==t?void 0:t.menu_name),1)])),_:2},1024)])])),_:2},1032,["checked","onClick"])]),w(g("div",ee,[(null==t?void 0:t.title_button)?(d(!0),r(m,{key:0},f(null==t?void 0:t.title_button,(({title:t,button:a},n)=>(d(),r(m,{key:`${e.sid}_${i}_${n}`},[c(ie,{checked:k(ye).layer.includes(`${e.sid}_${i}_${n}`),onClick:s=>pe({key:`${e.sid}_${i}_${n}`,level1:e.sid,level2:1*i,layer:n,idx:l,title:t,button:a,type:"layer"})},{default:v((()=>[y(" 层号: "+h(n),1)])),_:2},1032,["checked","onClick"]),g("div",le,[(d(!0),r(m,null,f(t,(t=>(d(),p(ie,{key:null==t?void 0:t.sid,checked:k(ye).title.includes(t.sid),onClick:a=>pe({key:t.sid,level1:e.sid,level2:1*i,layer:n,idx:l,type:"title"})},{default:v((()=>[y(h(t.field_name),1)])),_:2},1032,["checked","onClick"])))),128)),(d(!0),r(m,null,f(a,(t=>(d(),p(ie,{key:t.sid,checked:k(ye).title.includes(t.sid),onClick:a=>pe({key:t.sid,level1:e.sid,level2:1*i,layer:n,idx:l,type:"title"})},{default:v((()=>[te,y(" "+h(t.field_name),1)])),_:2},1032,["checked","onClick"])))),128))])],64)))),128)):x("",!0)],512),[[U,k(I)[i]]])],64)))),128))])],64)))),128)):(d(),p(o,{key:1},{description:v((()=>[y(" 无菜单数据 ")])),_:1}))])),_:1},8,["spinning"])])])),_:1}),k(se)&&(null==(i=null==(t=Pe.value)?void 0:t.permissions_edit)?void 0:i.page_display)?(d(),p(z,{key:0,loading:k(_e),status:"primary",size:"default",content:"组权限更新",class:"submit-btn",onClick:ge},null,8,["loading"])):x("",!0)],64)}}},[["__scopeId","data-v-a5b62e27"]]);export{ae as default};
