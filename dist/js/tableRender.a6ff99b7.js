import{aR as e,H as a,r as l,b0 as t,N as i,co as u,q as r,ai as o,a0 as d,ad as n}from"./index.872a2bd0.js";import{a as s,v as c}from"./alertLevel.8dae0e72.js";const _="public/from-option/",v={getFormOptionList:(a,l)=>e.get(`${_}list/${a}/${l}`),postFormOptionAdd:(a,l)=>e.post(`${_}add/${a}`,l),putFormOptionEdit:(a,l)=>e.put(`${_}edit/${a}`,l),delFormOptionDel:a=>e.delete(`${_}del/${a}`)},p={handleDataSourceType:async({title:a,title_data:l})=>{p.handleCommonDataSource(a);let{page_data_source:t,field:i}=a;if(t){let u=null==t?void 0:t.data_source;u&&(["url"].indexOf(u)>-1&&t.url&&(a.get_data_api=function(){e.get(t.url).then((async e=>{let u=e;(null==t?void 0:t.received_key)&&(u=e[null==t?void 0:t.received_key]),a.title_data=u,l.value[i]=u}))},await a.get_data_api()),"data"===u&&(a.title_data=null==t?void 0:t.data,l.value[i]=null==t?void 0:t.data))}return a},handleCommonDataSource:async e=>{let{page_data_source:a,field:l}=e;switch(l){case"virtual_teams":case"virtual_team_v3_id":e.page_data_source=Object.assign({url:"/public/virtual-team/list",label:"group_name",data_source:"url",tooltip_text:"虚拟用户组用于控制行数据的权限",template_render:{name:"opsVirtualTeam"}},a);break;case"cloud_source":e.page_data_source=Object.assign({children_field:"cloud_master_account_id",need_slots:!0,template_render:{name:"myCloud"}},a);break;case"cloud_master_account_id":e.page_data_source=Object.assign({url:"/public/cloud-account-name/list",data_source:"url",label:"page_display"},a);break;case"zone_id":e.page_data_source=Object.assign({need_slots:!0,children_field:"region_id"},a);break;case"region_id":e.page_data_source=Object.assign({url:"/public/cloud-regions/list",data_source:"url"},a)}},getTitle:async({layer:n=1,customTitleButton:_,isEdit:m=!1,customTitle:f=[]})=>{let g=l(f),b=l([]),h=i();const{current_user_menu:y}=u(h);let k=r((()=>{var e;return null==(e=y.value)?void 0:e.current_menu})),w=r((()=>{var e;return null==(e=y.value)?void 0:e.current_parent_menu}));const O=r((()=>{var e,a,l,t,i,u;return(null==(a=null==(e=y.value)?void 0:e.current_menu)?void 0:a.sid)||(null==(t=null==(l=y.value)?void 0:l.current_menu)?void 0:t.id)||(null==(u=null==(i=k.value)?void 0:i.current_all_second_menu)?void 0:u.id)}));let T=l({});const{generateCmdbFormTitle:S,formState:$,initFormState:j,rules:C}=((i,{currentMenuID:u,layer:r})=>{let o=a({}),d=a({}),n=a({}),_=l({});return{generateCmdbFormTitle:async(a=[])=>{try{u.value&&(_.value=await v.getFormOptionList(u.value,r))}catch(l){_.value={}}for(let p in a){let l=a[p];const{sid:m,field:f,field_name:g,page_data_source:b,edit_display:h,edit_required:y}=l;if(b&&(null==b?void 0:b.data_source)&&h&&("url"===(null==b?void 0:b.data_source)?Object.prototype.hasOwnProperty.call(i.value,f)||(null==b?void 0:b.url)&&(l.get_data_api=e.get(null==b?void 0:b.url),await l.get_data_api.then((async e=>{let a=e;(null==b?void 0:b.received_key)&&(a=e[null==b?void 0:b.received_key]),i.value[f]=a}))):"user_custom"===(null==b?void 0:b.data_source)?(l.get_data_api=async()=>await v.getFormOptionList(u.value,r),_.value&&_.value[m]&&(i.value[f]=_.value[m])):"data"===(null==b?void 0:b.data_source)&&(i.value[f]=null==b?void 0:b.data)),h){let e="",a=[];if(y&&a.push({required:!0,message:`${g}不能为空`}),b){if(null==b?void 0:b.data_source)["url","data"].indexOf(b.data_source)>-1&&("checkbox"===b.form_type||"radio"!==b.form_type&&b.multiple)&&(e=[]);else{let l=b.form_type;if(l)switch(l){case"json":e=null,a.push({validator:s,message:"请输入正确的json格式"});break;case"phone":e=null,a.push({validator:t.isValidMobilePhone,message:"请输入正确的手机号"});break;case"checkbox":case"input_tag":case"table":case"dynamic_form":e=[];break;case"select":b.multiple&&(e=[]);break;case"boole":e=b.unchecked||0;break;case"alert_level":e={},y&&a.push({validator:c,message:"此项不能为空"});break;default:e=null}}(null==b?void 0:b.default_value)&&(e=b.default_value)}d[f]=e,o[f]=e,a.length&&(n[f]=a)}}},formState:d,initFormState:o,rules:n,title_data:i,userCustomSelectItem:_}})(T,{currentMenuID:O,layer:n});if(O.value&&n&&!f.length){g.value=[],b.value=[];try{const e=await o.getCurrentMenuTitleApi({layer:n,id:O.value});let a=[],l=(null==e?void 0:e.title_data)||{};if(l)for(let t in l)for(let e of l[t]){e.layer=Number(n);let{types:l}=e;if(1===l){let l=await p.handleDataSourceType({title:e,title_data:T});g.value.push(l),a.push(l)}2===l&&b.value.push(e)}h.handleSetCurrentMenu({current_parent_menu:w.value,current_menu:Object.assign({},k.value,(null==e?void 0:e.page_data_source)?{page_data_source:null==e?void 0:e.page_data_source}:{})}),m&&await S(a),_&&_(l)}catch(F){g.value=[],b.value=[]}g.value=d.orderBy(g.value,[["sorting","asc"]])}else m&&await S(g.value);return{title:g,button:b,formState:$,initFormState:j,rules:C,currentMenuID:O,title_data:T}},formatTitle:async({title:e,tableType:a,isCustomTitle:t=!1,page_title_data:i})=>{var u,r,o;let s=l([]),c=l([]),_=l([]),v=l({});if(i=n(i)?i:l({}),e)for(let l in e){let n=e[l]||{},{field:m,field_name:f,page_data_source:g,search_display:b,page_display:h,sub_page_display:y,page_sort:k,get_data_api:w}=n;t&&await p.handleDataSourceType({title:n,title_data:v});let O={field:m,title:f,showOverflow:!0,sortable:!("server"===a&&!k),oriTitle:n,minWidth:"id"===m?"80":(null==g?void 0:g.width)||"120",page_data_source:g,get_data_api:w,title_data:i.value};if(h){if((null==g?void 0:g.column)&&(null==(u=null==g?void 0:g.column)?void 0:u.tooltip)&&(O[null==(r=null==g?void 0:g.column)?void 0:r.position]={content:null==(o=null==g?void 0:g.column)?void 0:o.tooltip,icon:"vxe-icon-question-circle-fill"}),null==g?void 0:g.children_field){let l=d.find(e,(e=>(null==e?void 0:e.field)===(null==g?void 0:g.children_field)&&n.block===e.block));if(l){let e={title:l.field_name,minWidth:(null==g?void 0:g.width)||"120",sortable:!("server"===a&&!l.page_sort)};(null==g?void 0:g.need_slots)?e.slots={default:l.field}:e.formatter=({cellValue:e,row:a})=>`${a[m]?a[m]:""} \n ${e||""}`,O.children=[{...l,...e}]}}d.find(e,(e=>{var a;return(null==(a=null==e?void 0:e.page_data_source)?void 0:a.children_field)===m&&n.block===e.block}))||s.value.push(O)}y&&c.value.push(O),b&&_.value.push(O)}return{table_columns:s.value,sub_page_columns:c.value,table_title_field_search:_.value,table_title_data:v}},setColumn:async({layer:e,customOrder:a,tableType:t})=>{let i=l([]),u=l([]),r=l(null),{title_data:o,button:d,title:n}=await p.getTitle({layer:e}),{table_columns:s,table_title_field_search:c,sub_page_columns:_}=await p.formatTitle({title:n.value,tableType:t,page_title_data:o});return i.value=s,u.value=c,a?a():Array.isArray(i.value)&&i.value.length&&"operation"!==i.value[0].field&&(r.value={field:i.value[0].field,order:"DESC"}),{title_data:o,columns:i,title_field_search:u,order:r,button:d,title:n,sub_page_columns:_}}};export{v as f,p as t};
