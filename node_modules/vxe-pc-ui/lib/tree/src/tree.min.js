"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_ui=require("../../ui"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vn=require("../../ui/src/vn"),_dom=require("../../ui/src/dom"),_loading=_interopRequireDefault(require("../../loading/src/loading"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getNodeUniqueId(){return _xeUtils.default.uniqueId("node_")}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTree",props:{data:Array,height:[String,Number],minHeight:{type:[String,Number],default:()=>(0,_ui.getConfig)().tree.minHeight},loading:Boolean,loadingConfig:Object,accordion:{type:Boolean,default:()=>(0,_ui.getConfig)().tree.accordion},childrenField:{type:String,default:()=>(0,_ui.getConfig)().tree.childrenField},valueField:{type:String,default:()=>(0,_ui.getConfig)().tree.valueField},keyField:{type:String,default:()=>(0,_ui.getConfig)().tree.keyField},parentField:{type:String,default:()=>(0,_ui.getConfig)().tree.parentField},titleField:{type:String,default:()=>(0,_ui.getConfig)().tree.titleField},hasChildField:{type:String,default:()=>(0,_ui.getConfig)().tree.hasChildField},transform:Boolean,isCurrent:Boolean,isHover:Boolean,showLine:{type:Boolean,default:()=>(0,_ui.getConfig)().tree.showLine},trigger:String,indent:{type:Number,default:()=>(0,_ui.getConfig)().tree.indent},showRadio:{type:Boolean,default:()=>(0,_ui.getConfig)().tree.showRadio},checkNodeKey:{type:[String,Number],default:()=>(0,_ui.getConfig)().tree.checkNodeKey},radioConfig:Object,showCheckbox:{type:Boolean,default:()=>(0,_ui.getConfig)().tree.showCheckbox},checkNodeKeys:{type:Array,default:()=>(0,_ui.getConfig)().tree.checkNodeKeys},checkboxConfig:Object,nodeConfig:Object,lazy:Boolean,toggleMethod:Function,loadMethod:Function,showIcon:{type:Boolean,default:!0},iconOpen:{type:String,default:()=>(0,_ui.getConfig)().tree.iconOpen},iconClose:{type:String,default:()=>(0,_ui.getConfig)().tree.iconClose},iconLoaded:{type:String,default:()=>(0,_ui.getConfig)().tree.iconLoaded},size:{type:String,default:()=>(0,_ui.getConfig)().tree.size||(0,_ui.getConfig)().size}},emits:["update:modelValue","update:checkNodeKey","update:checkNodeKeys","node-click","node-dblclick","current-change","radio-change","checkbox-change","load-success","load-error"],setup(I,e){const{emit:o,slots:O}=e;var t=_xeUtils.default.uniqueId();const c=(0,_ui.useSize)(I)["computeSize"],u=(0,_vue.ref)(),w=(0,_vue.reactive)({currentNode:null,nodeMaps:{},selectRadioKey:I.checkNodeKey,treeList:[],treeExpandedMaps:{},treeExpandLazyLoadedMaps:{},selectCheckboxMaps:{},indeterminateCheckboxMaps:{}});const y={refElem:u},V=(0,_vue.computed)(()=>I.titleField||"title"),d=(0,_vue.computed)(()=>I.keyField||"id"),h=(0,_vue.computed)(()=>{var e=d.value;return I.valueField||e}),E=(0,_vue.computed)(()=>I.parentField||"parentId"),R=(0,_vue.computed)(()=>I.childrenField||"children"),K=(0,_vue.computed)(()=>I.hasChildField||"hasChild"),N=(0,_vue.computed)(()=>{var e=v.value["isCurrent"];return _xeUtils.default.isBoolean(e)?e:I.isCurrent}),m=(0,_vue.computed)(()=>{var e=v.value["isHover"];return _xeUtils.default.isBoolean(e)?e:I.isHover}),T=(0,_vue.computed)(()=>Object.assign({showIcon:!0},(0,_ui.getConfig)().tree.radioConfig,I.radioConfig)),B=(0,_vue.computed)(()=>Object.assign({showIcon:!0},(0,_ui.getConfig)().tree.checkboxConfig,I.checkboxConfig)),v=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().tree.nodeConfig,I.nodeConfig)),b=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().tree.loadingConfig,I.loadingConfig)),M=(0,_vue.computed)(()=>{var{height:e,minHeight:t}=I,a={};return e&&(a.height=(0,_dom.toCssUnit)(e)),t&&(a.minHeight=(0,_dom.toCssUnit)(t)),a}),L={computeRadioOpts:T,computeCheckboxOpts:B,computeNodeOpts:v},p={xID:t,props:I,context:e,internalData:{},reactData:w,getRefMaps:()=>y,getComputeMaps:()=>L},j=e=>{var t=h.value,e=_xeUtils.default.get(e,t);return _xeUtils.default.eqNull(e)?"":encodeURIComponent(e)};const a=e=>{var t=w["selectRadioKey"];return t===e};const D=e=>{var t=w["selectCheckboxMaps"];return!!t[e]};const S=e=>{var t=w["indeterminateCheckboxMaps"];return!!t[e]};const U=e=>{o("update:checkNodeKeys",e)},P=e=>{o("update:checkNodeKey",e)};const l=(e,t)=>{const a=Object.assign({},w.selectCheckboxMaps);e.forEach(e=>{t?a[e]=!0:a[e]&&delete a[e]}),w.selectCheckboxMaps=a},n=e=>{const t={};e&&e.forEach(e=>{t[e]=!0}),w.selectCheckboxMaps=t},r=(e,t,a)=>{t?a[e]||(a[e]=!0):a[e]&&delete a[e]},z=(e,t,a)=>{o(e,(0,_ui.createEvent)(a,{$tree:p},t))},s={dispatchEvent:z,clearCurrentNode(){return(w.currentNode=null,_vue.nextTick)()},getCurrentNodeId(){var e=w["currentNode"];return e?j(e):null},getCurrentNode(){var{currentNode:e,nodeMaps:t}=w;if(e){t=t[e];if(t)return t.item}return null},setCurrentNodeId(e){var t=w["nodeMaps"],t=t[e];return w.currentNode=t?t.item:null,(0,_vue.nextTick)()},setCurrentNode(e){return w.currentNode=e,(0,_vue.nextTick)()},clearRadioNode(){return(w.selectRadioKey=null,_vue.nextTick)()},getRadioNodeId(){return w.selectRadioKey||null},getRadioNode(){var{selectRadioKey:e,nodeMaps:t}=w;if(e){t=t[e];if(t)return t.item}return null},setRadioNodeId(e){return w.selectRadioKey=e,(0,_vue.nextTick)()},setRadioNode:e=>(e&&(w.selectRadioKey=j(e)),(0,_vue.nextTick)()),setCheckboxNode:(e,t)=>(e&&(_xeUtils.default.isArray(e)||(e=[e]),l(e.map(e=>j(e)),t)),(0,_vue.nextTick)()),setCheckboxByNodeId:(e,t)=>(e&&(_xeUtils.default.isArray(e)||(e=[e]),l(e,t)),(0,_vue.nextTick)()),getCheckboxNodeIds(){var e=w["selectCheckboxMaps"];return Object.keys(e)},getCheckboxNodes(){const{nodeMaps:a,selectCheckboxMaps:e}=w,o=[];return _xeUtils.default.each(e,(e,t)=>{t=a[t];t&&o.push(t.item)}),o},clearCheckboxNode(){return w.selectCheckboxMaps={},(0,_vue.nextTick)()},setAllCheckboxNode(e){const t={};var a=R.value;return e&&_xeUtils.default.eachTree(w.treeList,e=>{e=j(e);t[e]=!0},{children:a}),w.selectCheckboxMaps=t,(0,_vue.nextTick)()},clearExpandNode(){return s.clearAllExpandNode()},clearAllExpandNode(){return _xeUtils.default.each(w.nodeMaps,e=>{e.treeLoaded=!1}),w.treeExpandedMaps={},(0,_vue.nextTick)()},setExpandByNodeId(e,t){const a=Object.assign({},w.treeExpandedMaps);return e&&((e=_xeUtils.default.isArray(e)?e:[e]).forEach(e=>{r(e,t,a)}),w.treeExpandedMaps=a),(0,_vue.nextTick)()},getExpandNodeIds(){var e=w["treeExpandedMaps"];return Object.keys(e)},getExpandNodes(){const{nodeMaps:a,treeExpandedMaps:e}=w,o=[];return _xeUtils.default.each(e,(e,t)=>{t=a[t];t&&o.push(t.item)}),o},setExpandNode(e,t){const a=Object.assign({},w.treeExpandedMaps);return e&&((e=_xeUtils.default.isArray(e)?e:[e]).forEach(e=>{e=j(e);r(e,t,a)}),w.treeExpandedMaps=a),(0,_vue.nextTick)()},toggleExpandByNodeId(e){const t=Object.assign({},w.treeExpandedMaps);return e&&((e=_xeUtils.default.isArray(e)?e:[e]).forEach(e=>{r(e,!t[e],t)}),w.treeExpandedMaps=t),(0,_vue.nextTick)()},toggleExpandNode(e){const t=Object.assign({},w.treeExpandedMaps);return e&&((e=_xeUtils.default.isArray(e)?e:[e]).forEach(e=>{e=j(e);r(e,!t[e],t)}),w.treeExpandedMaps=t),(0,_vue.nextTick)()},setAllExpandNode(e){const a={},o=R.value;return e&&_xeUtils.default.eachTree(w.treeList,e=>{var t=_xeUtils.default.get(e,o);t&&t.length&&(t=j(e),a[t]=!0)},{children:o}),w.treeExpandedMaps=a,(0,_vue.nextTick)()},reloadExpandNode(e){var t=I["lazy"];return t?(s.clearExpandLoaded(e),_(e)):(0,_vue.nextTick)()},clearExpandLoaded(e){var t=I["lazy"],a=w["nodeMaps"];return t&&(t=a[j(e)])&&(t.treeLoaded=!1),(0,_vue.nextTick)()},loadChildrenNode(r,e){const{lazy:t,transform:a}=I,i=w["nodeMaps"];if(!t)return Promise.resolve([]);const o=R.value,l=i[j(r)],s=l?l.level:0,c=l?l.nodes:[];return(e=>{const a=h.value;return Promise.resolve(e.map(e=>{var t,e=Object.assign({},e);return j(e)||(t=getNodeUniqueId(),_xeUtils.default.set(e,a,t)),e}))})(e).then(e=>(_xeUtils.default.eachTree(e,(e,t,a,o,n,d)=>{e=j(e);i[e]={item:r,itemIndex:-1,items:a,parent:n||l.item,nodes:c.concat(d),level:s+d.length,lineCount:0,treeLoaded:!1}},{children:o}),r[o]=e,a&&(r[o]=e),x(r),e))},isExpandByNode:e=>{var t=w["treeExpandedMaps"];return!!t[j(e)]},isCheckedByRadioNodeId:a,isCheckedByRadioNode:e=>a(j(e)),isCheckedByCheckboxNodeId:D,isIndeterminateByCheckboxNode:e=>S(j(e)),isCheckedByCheckboxNode:e=>D(j(e))},i=e=>{var t=I["transform"],a=d.value,o=E.value,n=R.value;w.treeList=t?_xeUtils.default.toArrayTree(e,{key:a,parentKey:o,mapChildren:n}):e?e.slice(0):[];{t=w.treeList;const i=h.value,l=(a=R.value,{});_xeUtils.default.eachTree(t,(e,t,a,o,n,d)=>{let r=j(e);r||(r=getNodeUniqueId(),_xeUtils.default.set(e,i,r)),l[r]={item:e,itemIndex:t,items:a,parent:n,nodes:d,level:d.length,lineCount:0,treeLoaded:!1}},{children:a}),w.nodeMaps=l}},g=(e,o,n)=>{var t=w["treeExpandedMaps"],a=R.value,d=j(e);n.lineCount++,t[d]&&_xeUtils.default.arrayEach(e[a],(e,t,a)=>{(!o||t<a.length-1)&&g(e,!1,n)})},x=e=>{const a=w["nodeMaps"];e&&(e=j(e),e=a[e])&&_xeUtils.default.lastArrayEach(e.nodes,e=>{var t=j(e),t=a[t];t&&(t.lineCount=0,g(e,!0,t))})},$=(e,t)=>{var{showRadio:a,showCheckbox:o,trigger:n}=I,d=T.value,r=B.value;let i=!1,l=!1,s=!1,c=!1;N.value?(i=!0,((e,t)=>{e.preventDefault();const a=v.value,{currentMethod:o,trigger:n}=a,d=R.value,r=_xeUtils.default.get(t,d),i=r&&r.length;let l=!!o;if(n==="child"){if(i)return}else if(n==="parent")if(!i)return;if(o)l=!o({node:t});var s;l||(s=!0,w.currentNode=t,z("current-change",{node:t,checked:!0},e))})(e,t)):w.currentNode&&(w.currentNode=null),"node"===n&&(c=!0,F(e,t)),a&&"node"===d.trigger&&(l=!0,q(e,t)),o&&"node"===r.trigger&&(s=!0,A(e,t)),z("node-click",{node:t,triggerCurrent:i,triggerRadio:l,triggerCheckbox:s,triggerExpand:c},e)},_=d=>{var e=B.value;const r=I["loadMethod"],i=e["checkStrictly"];return new Promise(e=>{if(r){var t=Object.assign({},w.treeExpandLazyLoadedMaps),a=w["nodeMaps"];const o=j(d),n=a[o];t[o]=!0,w.treeExpandLazyLoadedMaps=t,Promise.resolve(r({$tree:p,node:d})).then(a=>{var e=w["treeExpandLazyLoadedMaps"];if(n.treeLoaded=!0,e[o]&&(e[o]=!1),a=_xeUtils.default.isArray(a)?a:[])return s.loadChildrenNode(d,a).then(e=>{var t=Object.assign({},w.treeExpandedMaps);return e.length&&!t[o]&&(t[o]=!0),w.treeExpandedMaps=t,!i&&s.isCheckedByCheckboxNodeId(o)&&l(e.map(e=>j(e)),!0),x(d),z("load-success",{node:d,data:a},new Event("load-success")),(0,_vue.nextTick)()});x(d),z("load-success",{node:d,data:a},new Event("load-success"))}).catch(e=>{var t=w["treeExpandLazyLoadedMaps"];n.treeLoaded=!1,t[o]&&(t[o]=!1),x(d),z("load-error",{node:d,data:e},new Event("load-error"))}).finally(()=>(0,_vue.nextTick)())}else e()})},X=(e,t)=>{const{lazy:o,accordion:a,toggleMethod:n}=I,{nodeMaps:d,treeExpandLazyLoadedMaps:r}=w,i=Object.assign({},w.treeExpandedMaps),l=R.value,s=K.value,c=[];let u=n?e.filter(e=>n({$tree:p,expanded:t,node:e})):e;a&&(u=u.length?[u[u.length-1]]:[],e=j(u[0]),e=d[e])&&e.items.forEach(e=>{e=j(e);i[e]&&delete i[e]});const h=[];return t?u.forEach(e=>{var t,a=j(e);i[a]||(t=d[a],o&&e[s]&&!t.treeLoaded&&!r[a]?c.push(_(e)):e[l]&&e[l].length&&(i[a]=!0,h.push(e)))}):u.forEach(e=>{var t=j(e);i[t]&&(delete i[t],h.push(e))}),w.treeExpandedMaps=i,h.forEach(x),Promise.all(c)},F=(e,t)=>{var a=I["lazy"],{treeExpandedMaps:o,treeExpandLazyLoadedMaps:n}=w,d=j(t),o=!o[d];e.stopPropagation(),a&&n[d]||X([t],o)},f=(e,n,d)=>{var t=R.value,t=_xeUtils.default.get(e,t),e=j(e);if(t&&t.length){let a=!1,o=0;t.forEach(e=>{var e=j(e),t=n[e];(t||d[e])&&(t&&o++,a=!0)}),o===t.length?(n[e]||(n[e]=!0),d[e]&&delete d[e]):(n[e]&&delete n[e],d[e]=a)}else d[e]&&delete d[e]},G=()=>{var e=w["treeList"];const l=R.value;var t=B.value["checkStrictly"];if(!t){const s=Object.assign({},w.selectCheckboxMaps),c={};_xeUtils.default.eachTree(e,(e,t,a,o,n,d)=>{var r=_xeUtils.default.get(e,l);if(r&&r.length||f(e,s,c),t===a.length-1)for(let e=d.length-2;0<=e;e--){var i=d[e];f(i,s,c)}}),w.selectCheckboxMaps=s,w.indeterminateCheckboxMaps=c}},A=(e,a)=>{e.preventDefault(),e.stopPropagation();var{checkStrictly:o,checkMethod:n}=B.value;let t=!!n;if(!(t=n?!n({node:a}):t)){const r=Object.assign({},w.selectCheckboxMaps);var n=R.value,d=j(a);let t=!1;r[d]?delete r[d]:(t=!0,r[d]=t),o||_xeUtils.default.eachTree(_xeUtils.default.get(a,n),e=>{e=j(e);t?r[e]||(r[e]=!0):r[e]&&delete r[e]},{children:n}),w.selectCheckboxMaps=r,G();d=Object.keys(w.selectCheckboxMaps);U(d),z("checkbox-change",{node:a,value:d,checked:t},e)}},q=(e,t)=>{e.preventDefault(),e.stopPropagation();var a=T.value["checkMethod"];let o=!!a;(o=a?!a({node:t}):o)||(a=j(t),w.selectRadioKey=a,P(a),z("radio-change",{node:t,value:a,checked:!0},e))};Object.assign(p,s,{});const H=a=>{var{lazy:e,showRadio:t,showCheckbox:o,showLine:n,indent:d,iconOpen:r,iconClose:i,iconLoaded:l,showIcon:s}=I,{nodeMaps:c,treeExpandedMaps:u,currentNode:h,selectRadioKey:v,treeExpandLazyLoadedMaps:p}=w,g=R.value,x=V.value,_=K.value,g=_xeUtils.default.get(a,g),f=g&&g.length,C=O.title,k=O.extra,y=j(a),E=u[y],c=c[y],x=_xeUtils.default.get(a,x);const N=[];f&&u[y]&&(n&&N.push((0,_vue.h)("div",{key:"line",class:"vxe-tree--node-child-line",style:{height:`calc(${c.lineCount} * var(--vxe-ui-tree-node-height) - var(--vxe-ui-tree-node-height) / 2)`,left:(c.level+1)*(d||1)+"px"}})),g.forEach(e=>{N.push(H(e))}));let m=!1,b=(t&&(m=y==v),!1),M=(o&&(b=D(y)),!1),L=!1,U=!1;return e&&(L=!!p[y],M=a[_],U=!!c.treeLoaded),(0,_vue.h)("div",{class:["vxe-tree--node-wrapper","node--level-"+c.level],nodeid:y},[(0,_vue.h)("div",{class:["vxe-tree--node-item",{"is--current":h&&y===j(h),"is-radio--checked":m,"is-checkbox--checked":b}],style:{paddingLeft:(c.level-1)*(d||1)+"px"},onClick(e){$(e,a)},onDblclick(e){var t;e=e,t=a,z("node-dblclick",{node:t},e)}},[s||n?(0,_vue.h)("div",{class:"vxe-tree--node-item-switcher"},s&&(!e||U?f:M)?[(0,_vue.h)("div",{class:"vxe-tree--node-item-icon",onClick(e){F(e,a)}},[(0,_vue.h)("i",{class:L?l||(0,_ui.getIcon)().TREE_NODE_LOADED:E?r||(0,_ui.getIcon)().TREE_NODE_OPEN:i||(0,_ui.getIcon)().TREE_NODE_CLOSE})])]:[]):(0,_vue.createCommentVNode)(),((t,e)=>{var a=I["showRadio"],{showIcon:o,checkMethod:n,visibleMethod:d}=T.value,d=!d||d({node:t});let r=!!n;return a&&o&&d?(n&&(r=!n({node:t})),(0,_vue.h)("div",{class:["vxe-tree--radio-option",{"is--checked":e,"is--disabled":r}],onClick:e=>{r||q(e,t)}},[(0,_vue.h)("span",{class:["vxe-radio--icon",e?(0,_ui.getIcon)().RADIO_CHECKED:(0,_ui.getIcon)().RADIO_UNCHECKED]})])):(0,_vue.createCommentVNode)()})(a,m),((t,e,a)=>{var o=I["showCheckbox"],{showIcon:n,checkMethod:d,visibleMethod:r}=B.value,e=S(e),r=!r||r({node:t});let i=!!d;return o&&n&&r?(d&&(i=!d({node:t})),(0,_vue.h)("div",{class:["vxe-tree--checkbox-option",{"is--checked":a,"is--indeterminate":e,"is--disabled":i}],onClick:e=>{i||A(e,t)}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",e?(0,_ui.getIcon)().CHECKBOX_INDETERMINATE:a?(0,_ui.getIcon)().CHECKBOX_CHECKED:(0,_ui.getIcon)().CHECKBOX_UNCHECKED]})])):(0,_vue.createCommentVNode)()})(a,y,b),(0,_vue.h)("div",{class:"vxe-tree--node-item-inner"},[(0,_vue.h)("div",{class:"vxe-tree--node-item-title"},C?(0,_vn.getSlotVNs)(C({node:a})):""+x),k?(0,_vue.h)("div",{class:"vxe-tree--node-item-extra"},(0,_vn.getSlotVNs)(k({node:a}))):(0,_vue.createCommentVNode)()])]),f&&u[y]?(0,_vue.h)("div",{class:"vxe-tree--node-child-wrapper"},N):(0,_vue.createCommentVNode)()])};const C=(0,_vue.ref)(0),k=((0,_vue.watch)(()=>I.data?I.data.length:0,()=>{C.value++}),(0,_vue.watch)(()=>I.data,()=>{C.value++}),(0,_vue.watch)(C,()=>{i(I.data||[])}),(0,_vue.watch)(()=>I.checkNodeKey,e=>{w.selectRadioKey=e}),(0,_vue.ref)(0));return(0,_vue.watch)(()=>I.checkNodeKeys?I.checkNodeKeys.length:0,()=>{k.value++}),(0,_vue.watch)(()=>I.checkNodeKeys,()=>{k.value++}),(0,_vue.watch)(k,()=>{n(I.checkNodeKeys||[])}),(0,_vue.onUnmounted)(()=>{w.treeList=[],w.treeExpandedMaps={},w.nodeMaps={}}),i(I.data||[]),n(I.checkNodeKeys||[]),p.renderVN=()=>{var{loading:e,trigger:t,showLine:a}=I,o=c.value,n=T.value,d=B.value,r=M.value,i=b.value,l=m.value;const s=O.loading;return(0,_vue.h)("div",{ref:u,class:["vxe-tree",{["size--"+o]:o,"show--line":a,"checkbox--highlight":d.highlight,"radio--highlight":n.highlight,"node--hover":l,"node--trigger":"node"===t,"is--loading":e}],style:r},[(o=w.treeList,(0,_vue.h)("div",{class:"vxe-tree--node-list-wrapper"},o.map(e=>H(e)))),(0,_vue.h)(_loading.default,{class:"vxe-tree--loading",modelValue:e,icon:i.icon,text:i.text},s?{default:()=>s({$tree:p})}:{})])},p},render(){return this.renderVN()}});