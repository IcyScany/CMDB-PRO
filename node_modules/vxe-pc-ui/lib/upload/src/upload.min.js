"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_vn=require("../..//ui/src/vn"),_log=require("../../ui/src/log"),_dom=require("../../ui/src/dom"),_util=require("./util"),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeUpload",props:{modelValue:[Array,String,Object],showList:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showList},moreConfig:Object,readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},mode:{type:String,default:()=>(0,_ui.getConfig)().upload.mode},imageTypes:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageTypes,!0)},imageConfig:{type:Object,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageConfig,!0)},imageStyle:{type:Object,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageStyle,!0)},fileTypes:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.fileTypes,!0)},dragSort:Boolean,dragToUpload:{type:Boolean,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.dragToUpload,!0)},pasteToUpload:{type:Boolean,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.pasteToUpload,!0)},keyField:String,singleMode:Boolean,urlMode:Boolean,multiple:Boolean,limitSize:{type:[String,Number],default:()=>(0,_ui.getConfig)().upload.limitSize},limitCount:{type:[String,Number],default:()=>(0,_ui.getConfig)().upload.limitCount},nameField:{type:String,default:()=>(0,_ui.getConfig)().upload.nameField},typeField:{type:String,default:()=>(0,_ui.getConfig)().upload.typeField},urlField:{type:String,default:()=>(0,_ui.getConfig)().upload.urlField},sizeField:{type:String,default:()=>(0,_ui.getConfig)().upload.sizeField},showErrorStatus:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showErrorStatus},showProgress:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showProgress},progressText:{type:String,default:()=>(0,_ui.getConfig)().upload.progressText},autoHiddenButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.autoHiddenButton},showUploadButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showUploadButton},buttonText:{type:String,default:()=>(0,_ui.getConfig)().upload.buttonText},buttonIcon:{type:String,default:()=>(0,_ui.getConfig)().upload.buttonIcon},showButtonText:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showButtonText},showButtonIcon:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showButtonIcon},showRemoveButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showRemoveButton},showDownloadButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showDownloadButton},showPreview:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showPreview},tipText:String,hintText:String,previewMethod:Function,uploadMethod:Function,beforeRemoveMethod:Function,removeMethod:Function,beforeDownloadMethod:Function,downloadMethod:Function,getUrlMethod:Function,getThumbnailUrlMethod:Function,size:{type:String,default:()=>(0,_ui.getConfig)().upload.size||(0,_ui.getConfig)().size}},emits:["update:modelValue","add","remove","remove-fail","download","download-fail","upload-success","upload-error","sort-dragend"],setup(C,e){const{emit:u,slots:y}=e,w=(0,_vue.inject)("$xeForm",null),I=(0,_vue.inject)("xeFormItemInfo",null),a=(0,_vue.inject)("$xeTable",null);var t=_xeUtils.default.uniqueId();const j=(0,_ui.useSize)(C)["computeSize"],g=(0,_vue.ref)(),p=(0,_vue.ref)(),c=(0,_vue.ref)(),m=(0,_vue.ref)(),b=(0,_vue.reactive)({isDragUploadStatus:!1,showMorePopup:!1,isActivated:!1,fileList:[],fileCacheMaps:{},isDragMove:!1,dragIndex:-1,dragTipText:""}),r={imagePreviewTypes:["jpg","jpeg","png","gif"],prevDragIndex:-1},l={refElem:g},U=(0,_vue.computed)(()=>{var e=C["readonly"];return null===e?!!w&&w.props.readonly:e}),M=(0,_vue.computed)(()=>{var e=C["disabled"];return null===e?!!w&&w.props.disabled:e}),D=(0,_vue.computed)(()=>C.keyField||"_X_KEY"),_=(0,_vue.computed)(()=>"image"===C.mode),T=(0,_vue.computed)(()=>C.nameField||"name"),E=(0,_vue.computed)(()=>C.typeField||"type"),S=(0,_vue.computed)(()=>C.urlField||"url"),V=(0,_vue.computed)(()=>C.sizeField||"size"),$=(0,_vue.computed)(()=>1024*_xeUtils.default.toNumber(C.limitSize)*1024),B=(0,_vue.computed)(()=>C.multiple?_xeUtils.default.toNumber(C.limitCount):1),f=(0,_vue.computed)(()=>{var e=C["multiple"],t=b["fileList"],o=B.value;return e?!o||t.length>=o:1<=t.length}),q=(0,_vue.computed)(()=>{var e=_xeUtils.default.toNumber(C.limitSize);return e?1048576<e?e/1048576+"T":1024<e?e/1024+"G":e+"M":""}),G=(0,_vue.computed)(()=>{var{limitSize:e,fileTypes:t,multiple:o,limitCount:a}=C,l=C.tipText||C.hintText,i=_.value,u=q.value;return _xeUtils.default.isString(l)?l:(l=[],i?(o&&a&&l.push((0,_ui.getI18n)("vxe.upload.imgCountHint",[a])),e&&u&&l.push((0,_ui.getI18n)("vxe.upload.imgSizeHint",[u]))):(t&&t.length&&l.push((0,_ui.getI18n)("vxe.upload.fileTypeHint",[t.join("/")])),e&&u&&l.push((0,_ui.getI18n)("vxe.upload.fileSizeHint",[u])),o&&a&&l.push((0,_ui.getI18n)("vxe.upload.fileCountHint",[a]))),l.join((0,_ui.getI18n)("vxe.base.comma")))}),i=(0,_vue.computed)(()=>Object.assign({},C.imageConfig||C.imageStyle)),H=(0,_vue.computed)(()=>{var{width:e,height:t}=i.value,o={};return e&&(o.width=(0,_dom.toCssUnit)(e)),t&&(o.height=(0,_dom.toCssUnit)(t)),o}),Y=(0,_vue.computed)(()=>Object.assign({showMoreButton:!0},C.moreConfig)),d={},h={xID:t,props:C,context:e,reactData:b,internalData:r,getRefMaps:()=>l,getComputeMaps:()=>d},P=()=>_xeUtils.default.uniqueId(),L=e=>{return e[D.value]},s=()=>{var{modelValue:e,multiple:t}=C,o=U.value;const l=D.value,i=T.value,u=E.value,n=S.value,r=V.value;e=e?(e?_xeUtils.default.isArray(e)?e:[e]:[]).map(e=>{if(!e||_xeUtils.default.isString(e)){var t=""+(e||""),o=_xeUtils.default.parseUrl(e);const a=(o?o.searchQuery[i]:"")||decodeURIComponent(""+(t||"")).split("/").pop()||"";return{[i]:a,[u]:(o?o.searchQuery[u]:"")||N(a),[n]:t,[r]:_xeUtils.default.toNumber(o?o.searchQuery[r]:0)||0,[l]:P()}}const a=e[i]||"";return e[i]=a,e[u]=e[u]||N(a),e[n]=e[n]||"",e[r]=e[r]||0,e[l]=e[l]||P(),e}):[];b.fileList=o||t?e:e.slice(0,1)},N=e=>{var t=e.lastIndexOf(".");return 0<t?e.substring(t+1).toLowerCase():""},O=(e,t,o)=>{u(e,(0,_ui.createEvent)(o,{$upload:h},t))},A=e=>{var{singleMode:t,urlMode:o}=C;const a=S.value,l=T.value;let i=e?e.slice(0):[];o&&(i=i.map(e=>{var t=e[a];if(t&&!_xeUtils.default.parseUrl(t).searchQuery[l])return""+t+(-1===t.indexOf("?")?"?":"&")+l+"="+encodeURIComponent(e[l]||"");return t})),u("update:modelValue",t?i[0]||null:i)},Q=e=>{var t=C.getThumbnailUrlMethod||(0,_ui.getConfig)().upload.getThumbnailUrlMethod;return t?t({$upload:h,option:e}):n(e)},n=e=>{var t=C.getUrlMethod||(0,_ui.getConfig)().upload.getUrlMethod,o=S.value;return t?t({$upload:h,option:e}):e[o]},X=(e,t)=>{var o=C.previewMethod||(0,_ui.getConfig)().upload.previewMethod;if(C.showPreview)if(o)o({$upload:h,option:t});else{var a=t;var{imageTypes:o,showDownloadButton:t}=C;const i=E.value,u=C.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;var l=r["imagePreviewTypes"];l.concat(o||[]).some(e=>(""+e).toLowerCase()===(""+a[i]).toLowerCase())&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:[n(a)],showDownloadButton:t,beforeDownloadMethod:u?()=>u({$upload:h,option:a}):void 0})}},W=(e,t,o)=>{var a=C["showDownloadButton"];const l=b["fileList"],i=C.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;C.showPreview&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:l.map(e=>n(e)),activeIndex:o,showDownloadButton:a,beforeDownloadMethod:i?({index:e})=>i({$upload:h,option:l[e]}):void 0})},K=(o,e)=>{const a=C["showErrorStatus"],l=L(o);var t=C.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod;return t?Promise.resolve(t({$upload:h,file:e,option:o,updateProgress(e){var t=b["fileCacheMaps"],t=t[L(o)];t&&(t.percent=Math.max(0,Math.min(99,_xeUtils.default.toNumber(e))))}})).then(e=>{var t=b["fileCacheMaps"],t=t[l];t&&(t.percent=100),Object.assign(o,e),O("upload-success",{option:o,data:e},null)}).catch(e=>{var t=b["fileCacheMaps"],t=t[l];t&&(t.status="error"),a?Object.assign(o,e):b.fileList=b.fileList.filter(e=>L(e)!==l),O("upload-error",{option:o,data:e},null)}).finally(()=>{var e=b["fileCacheMaps"],e=e[l];e&&(e.loading=!1)}):(t=b["fileCacheMaps"],(e=t[l])&&(e.loading=!1),Promise.resolve())},J=e=>{const{uploadMethod:t,urlMode:o}=C;var a,l=b["fileCacheMaps"],l=l[L(e)];(t||(0,_ui.getConfig)().upload.uploadMethod)&&l&&(a=l.file,l.loading=!0,l.status="",l.percent=0,K(e,a).then(()=>{o&&A(b.fileList)}))},v=(t,a)=>{var{multiple:e,urlMode:o}=C,l=b["fileList"];const i=C.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod,u=D.value,n=T.value,r=E.value,d=S.value,s=V.value;var v=$.value;const p=B.value;var g=q.value;let c=t;if(e&&p){if(l.length>=p)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.overCountErr",[p])}));const h=c.length-(p-l.length);if(0<h){const x=c.slice(p-l.length);_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",width:null,slots:{default(){return(0,_vue.h)("div",{class:"vxe-upload--file-message-over-error"},[(0,_vue.h)("div",{},(0,_ui.getI18n)("vxe.upload.overCountExtraErr",[p,h])),(0,_vue.h)("div",{class:"vxe-upload--file-message-over-extra"},x.map((e,t)=>(0,_vue.h)("div",{key:t,class:"vxe-upload--file-message-over-extra-item"},e.name)))])}}})}c=c.slice(0,p-l.length)}if(v)for(let e=0;e<t.length;e++)if(t[0].size>v)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.overSizeErr",[g])}));const m=Object.assign({},b.fileCacheMaps),_=e?l:[],f=[];c.forEach(e=>{var t=e["name"],o=P(),t={[n]:t,[r]:N(t),[s]:e.size,[d]:URL.createObjectURL(e),[u]:o},o=(i&&(m[o]={file:e,loading:!0,status:"",percent:0}),(0,_vue.reactive)(t));i&&f.push(K(o,e)),_.push(o),O("add",{option:o},a)}),b.fileList=_,b.fileCacheMaps=m,Promise.all(o?f:[]).then(()=>{A(_),w&&I&&w.triggerItemEvent(a,I.itemConfig.field,_)})},Z=t=>{var{multiple:e,imageTypes:o,fileTypes:a}=C,l=M.value,i=_.value;return l?Promise.resolve({status:!1,files:[],file:null}):(0,_util.readLocalFile)({multiple:e,types:i?o:a}).then(e=>(v(e.files,t),e))},ee=e=>{Z(e).catch(()=>{})},te=(e,t,o)=>{var a=b["fileList"];a.splice(o,1),A(a),w&&I&&w.triggerItemEvent(e,I.itemConfig.field,a),O("remove",{option:t},e)},oe=(t,o,a)=>{var e=C.beforeRemoveMethod||(0,_ui.getConfig)().upload.beforeRemoveMethod;const l=C.removeMethod||(0,_ui.getConfig)().upload.removeMethod;Promise.resolve(!e||e({$upload:h,option:o})).then(e=>{e?l?Promise.resolve(l({$upload:h,option:o})).then(()=>{te(t,o,a)}).catch(e=>e):te(t,o,a):O("remove-fail",{option:o},t)})},ae=(e,t)=>{O("download",{option:t},e)},le=(t,o)=>{var e=C.beforeDownloadMethod||(0,_ui.getConfig)().upload.beforeDownloadMethod;const a=C.downloadMethod||(0,_ui.getConfig)().upload.downloadMethod;Promise.resolve(!e||e({$upload:h,option:o})).then(e=>{e?a?Promise.resolve(a({$upload:h,option:o})).then(()=>{ae(t,o)}).catch(e=>e):ae(t,o):O("download-fail",{option:o},t)})},ie=e=>{var t,o,a,l=e.currentTarget,{clientX:e,clientY:i}=e;l&&({x:l,y:t,height:o,width:a}=l.getBoundingClientRect(),e<l||l+a<e||i<t||t+o<i)&&(b.isDragUploadStatus=!1)},ue=e=>{var t=e.dataTransfer;t&&(t=t["items"],t)&&t.length&&(e.preventDefault(),b.isDragUploadStatus=!0)},ne=(e,t)=>{var o=C["imageTypes"],a=r["imagePreviewTypes"];if(_.value){const l=a.concat(o&&o.length?o:[]);t=t.filter(e=>{const t=(""+(e.type.split("/")[1]||"")).toLowerCase();return!!l.some(e=>(""+e).toLowerCase()===t)})}t.length?v(t,e):_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.uploadTypeErr")})},re=e=>{var t=e.dataTransfer;t&&(t=t["items"],t)&&t.length&&(e.preventDefault(),(t=de(t)).length)&&ne(e,t),b.isDragUploadStatus=!1},de=e=>{const t=[];return _xeUtils.default.arrayEach(e,e=>{e=e.getAsFile();e&&t.push(e)}),t},x=()=>{const s=U.value,v=_.value;_ui.VxeUI.modal&&_ui.VxeUI.modal.open({title:s?(0,_ui.getI18n)("vxe.upload.morePopup.readTitle"):(0,_ui.getI18n)("vxe.upload.morePopup."+(v?"imageTitle":"fileTitle")),width:660,height:500,escClosable:!0,showMaximize:!0,resize:!0,maskClosable:!0,slots:{default(){var{showErrorStatus:e,dragToUpload:t,dragSort:o}=C,{isActivated:a,isDragMove:l,isDragUploadStatus:i,dragIndex:u}=b;const n=b["fileList"];var r=M.value,d={};return t&&-1===u&&(d.onDragover=ue,d.onDragleave=ie,d.onDrop=re),(0,_vue.h)("div",Object.assign({ref:p,class:["vxe-upload--more-popup",{"is--readonly":s,"is--disabled":r,"is--active":a,"show--error":e,"is--drag":i}]},d),[v?o?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(l?"":"-disabled"),tag:"div",class:"vxe-upload--image-more-list"},{default:()=>z(n,!0).concat(R(!0))}):(0,_vue.h)("div",{class:"vxe-upload--image-more-list"},z(n,!0).concat(R(!0))):(0,_vue.h)("div",{class:"vxe-upload--file-more-list"},[k(!0),o?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(l?"":"-disabled"),tag:"div",class:"vxe-upload--file-list"},{default:()=>F(n,!1)}):(0,_vue.h)("div",{class:"vxe-upload--file-list"},F(n,!0))]),o?(0,_vue.h)("div",{ref:m,class:"vxe-upload--drag-line"}):(0,_ui.renderEmptyElement)(h),i?(0,_vue.h)("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_ui.renderEmptyElement)(h)])}},onShow(){b.showMorePopup=!0},onHide(){b.showMorePopup=!1}})},se=(e,t,o)=>{var a,l=b["showMorePopup"],i=g.value,u=p.value,u=l?u:i;u&&(i=u.getBoundingClientRect(),u=c.value,a=m.value,l=l?a:u)&&(a=t.getBoundingClientRect(),l.style.display="block",l.style.top=Math.max(1,a.y-i.y)+"px",l.style.left=Math.max(1,a.x-i.x)+"px",l.style.height=a.height+"px",l.style.width=a.width-1+"px",l.setAttribute("drag-pos",o))},ve=e=>{e.stopPropagation(),e.dataTransfer&&e.dataTransfer.setDragImage((0,_dom.getTpImg)(),0,0);const t=e.currentTarget;e=t.parentElement,e=_xeUtils.default.findIndexOf(Array.from(e.children),e=>t===e);b.isDragMove=!0,b.dragIndex=e,setTimeout(()=>{b.isDragMove=!1},500)},pe=t=>{t.stopPropagation(),t.preventDefault();var o=b["dragIndex"];if(-1!==o){var a=_.value;const i=t.currentTarget;var l=i.parentElement,l=_xeUtils.default.findIndexOf(Array.from(l.children),e=>i===e);let e="";e=a?t.clientX-i.getBoundingClientRect().x<i.clientWidth/2?"left":"right":t.clientY-i.getBoundingClientRect().y<i.clientHeight/2?"top":"bottom",o===l?se(0,i,e):(se(0,i,e),r.prevDragIndex=l,r.prevDragPos=e)}},ge=e=>{var{fileList:t,dragIndex:o}=b,{prevDragIndex:a,prevDragPos:l}=r,i="bottom"===l||"right"===l?1:0,u=t[o];const n=t[a];u&&n&&(t.splice(o,1),a=_xeUtils.default.findIndexOf(t,e=>n===e)+i,t.splice(a,0,u),O("sort-dragend",{oldItem:u,newItem:n,dragPos:l,offsetIndex:i,_index:{newIndex:a,oldIndex:o}},e)),t=c.value,u=m.value,t&&(t.style.display=""),u&&(u.style.display=""),b.dragIndex=-1},ce=e=>{a&&e.stopPropagation(),b.isActivated=!0},me=e=>{var t=C["pasteToUpload"],o=b["isActivated"];o&&t&&(o=e.clipboardData||e.originalEvent.clipboardData)&&(t=o["items"],t)&&(o=de(t)).length&&(e.preventDefault(),ne(e,o))},_e=e=>{var t=g.value,o=p.value;let a=(0,_dom.getEventTargetNode)(e,t).flag;!a&&o&&(o=(t=o.parentElement||o)&&t.parentElement,a=(0,_dom.getEventTargetNode)(e,o).flag),b.isActivated=a},fe=()=>{b.isActivated=!1};t={dispatchEvent:O,choose(){return Z(null)}};Object.assign(h,t,{});const F=(e,u)=>{const{showRemoveButton:n,showDownloadButton:r,showProgress:d,progressText:s,showPreview:v,showErrorStatus:p,dragSort:g}=C,c=b["fileCacheMaps"],m=M.value,_=U.value,f=T.value,h=E.value,x=y.corner,w={};return g&&1<e.length&&(w.onDragstart=ve,w.onDragover=pe,w.onDragend=ge),e.map((t,o)=>{var e=L(t),a=c[e];const l=a&&a.loading,i=a&&"error"===a.status;return(0,_vue.h)("div",Object.assign({key:g?e:o,class:["vxe-upload--file-item",{"is--preview":v,"is--loading":l,"is--error":i}],fileid:e,draggable:!!g||null},w),[(0,_vue.h)("div",{class:"vxe-upload--file-item-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)()["UPLOAD_FILE_TYPE_"+(""+t[h]).toLocaleUpperCase()]||(0,_ui.getIcon)().UPLOAD_FILE_TYPE_DEFAULT})]),(0,_vue.h)("div",{class:"vxe-upload--file-item-name",onClick(e){l||i||X(e,t)}},""+(t[f]||"")),l?(0,_vue.h)("div",{class:"vxe-upload--file-item-loading-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]):(0,_vue.createCommentVNode)(),d&&l&&a?(0,_vue.h)("div",{class:"vxe-upload--file-item-loading-text"},s?_xeUtils.default.toFormatString(s,{percent:a.percent}):(0,_ui.getI18n)("vxe.upload.uploadProgress",[a.percent])):(0,_vue.createCommentVNode)(),p&&i?(0,_vue.h)("div",{class:"vxe-upload--image-item-error"},[(0,_vue.h)(_button.default,{icon:(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD,mode:"text",status:"primary",content:(0,_ui.getI18n)("vxe.upload.reUpload"),onClick(){J(t)}})]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-upload--file-item-btn-wrapper"},[x?(0,_vue.h)("div",{class:"vxe-upload--file-item-corner"},(0,_vn.getSlotVNs)(x({option:t,isMoreView:u,readonly:_}))):(0,_vue.createCommentVNode)(),r&&!l?(0,_vue.h)("div",{class:"vxe-upload--file-item-download-btn",onClick(e){le(e,t)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_DOWNLOAD})]):(0,_vue.createCommentVNode)(),!n||_||m||l?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--file-item-remove-btn",onClick(e){oe(e,t,o)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_REMOVE})])])])})},k=e=>{var{showUploadButton:t,buttonText:o,buttonIcon:a,showButtonText:l,showButtonIcon:i,autoHiddenButton:u}=C,n=M.value,r=U.value,d=G.value,s=f.value,v=y.default,p=y.tip||y.hint;return r||!t?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--file-action"},[u&&s?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--file-action-btn",onClick:ee},v?(0,_vn.getSlotVNs)(v({$upload:h})):[(0,_vue.h)(_button.default,{class:"vxe-upload--file-action-button",content:e||l?o?""+o:(0,_ui.getI18n)("vxe.upload.fileBtnText"):"",icon:i?a||(0,_ui.getIcon)().UPLOAD_FILE_ADD:"",disabled:n})]),e&&(d||p)?(0,_vue.h)("div",{class:"vxe-upload--file-action-tip"},p?(0,_vn.getSlotVNs)(p({$upload:h})):d):(0,_vue.createCommentVNode)()])},z=(e,u)=>{const{showRemoveButton:n,showProgress:r,progressText:d,showPreview:s,showErrorStatus:v,dragSort:p}=C,g=b["fileCacheMaps"],c=M.value,m=U.value,_=i.value,f=H.value,h=y.corner,x={onMousedown:ce};return p&&1<e.length&&(x.onDragstart=ve,x.onDragover=pe,x.onDragend=ge),e.map((t,o)=>{var e=L(t),a=g[e];const l=a&&a.loading,i=a&&"error"===a.status;return(0,_vue.h)("div",Object.assign({key:p?e:o,class:["vxe-upload--image-item",{"is--preview":s,"is--circle":_.circle,"is--loading":l,"is--error":i}],fileid:e,draggable:!!p||null},x),[(0,_vue.h)("div",{class:"vxe-upload--image-item-box",style:u?null:f,title:(0,_ui.getI18n)("vxe.upload.viewItemTitle"),onClick(e){l||i||W(e,t,o)}},[l&&a?(0,_vue.h)("div",{class:"vxe-upload--image-item-loading"},[(0,_vue.h)("div",{class:"vxe-upload--image-item-loading-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]),r?(0,_vue.h)("div",{class:"vxe-upload--image-item-loading-text"},d?_xeUtils.default.toFormatString(d,{percent:a.percent}):(0,_ui.getI18n)("vxe.upload.uploadProgress",[a.percent])):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)(),l?(0,_vue.createCommentVNode)():i&&v?(0,_vue.h)("div",{class:"vxe-upload--image-item-error"},[(0,_vue.h)(_button.default,{icon:(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD,mode:"text",status:"primary",content:(0,_ui.getI18n)("vxe.upload.reUpload"),onClick(){J(t)}})]):(0,_vue.h)("div",{class:"vxe-upload--image-item-img-wrapper"},[(0,_vue.h)("img",{class:"vxe-upload--image-item-img",src:Q(t)})]),(0,_vue.h)("div",{class:"vxe-upload--image-item-btn-wrapper",onClick(e){e.stopPropagation()}},[h?(0,_vue.h)("div",{class:"vxe-upload--file-item-corner"},(0,_vn.getSlotVNs)(h({option:t,isMoreView:u,readonly:m}))):(0,_vue.createCommentVNode)(),!n||m||c||l?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--image-item-remove-btn",onClick(e){e.stopPropagation(),oe(e,t,o)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_IMAGE_REMOVE})])])])])})},R=e=>{var{showUploadButton:t,buttonText:o,buttonIcon:a,showButtonText:l,showButtonIcon:i,autoHiddenButton:u}=C,n=U.value,r=G.value,d=f.value,s=H.value,v=y.default,p=y.hint;return n||!t||u&&d?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{key:"action",class:"vxe-upload--image-action"},[(0,_vue.h)("div",{class:"vxe-upload--image-action-btn",onClick:ee},v?v({$upload:h}):[(0,_vue.h)("div",{class:"vxe-upload--image-action-box",style:e?null:s},[i?(0,_vue.h)("div",{class:"vxe-upload--image-action-icon"},[(0,_vue.h)("i",{class:a||(0,_ui.getIcon)().UPLOAD_IMAGE_ADD})]):(0,_vue.createCommentVNode)(),e||l?(0,_vue.h)("div",{class:"vxe-upload--image-action-content"},o?""+o:(0,_ui.getI18n)("vxe.upload.imgBtnText")):(0,_vue.createCommentVNode)(),e&&(r||p)?(0,_vue.h)("div",{class:"vxe-upload--image-action-hint"},p?(0,_vn.getSlotVNs)(p({$upload:h})):r):(0,_vue.createCommentVNode)()])])])};const o=(0,_vue.ref)(0);return(0,_vue.watch)(()=>C.modelValue?C.modelValue.length:0,()=>{o.value++}),(0,_vue.watch)(()=>C.modelValue,()=>{o.value++}),(0,_vue.watch)(o,()=>{s()}),(0,_vue.onMounted)(()=>{"development"===process.env.NODE_ENV&&(C.multiple&&C.singleMode&&(0,_log.errLog)("vxe.error.errConflicts",["multiple","single-mode"]),C.imageStyle)&&(0,_log.warnLog)("vxe.error.delProp",["image-style","image-config"]),C.dragSort&&(0,_dom.initTpImg)(),_ui.globalEvents.on(h,"paste",me),_ui.globalEvents.on(h,"mousedown",_e),_ui.globalEvents.on(h,"blur",fe)}),(0,_vue.onUnmounted)(()=>{b.isDragUploadStatus=!1,_ui.globalEvents.off(h,"paste"),_ui.globalEvents.off(h,"mousedown"),_ui.globalEvents.off(h,"blur")}),s(),h.renderVN=()=>{var{showErrorStatus:e,dragToUpload:t,pasteToUpload:o,dragSort:a}=C,{isDragUploadStatus:l,showMorePopup:i,isActivated:u,dragIndex:n}=b,r=j.value,d=M.value,s=U.value,v=_.value,p={onMousedown:ce};return t&&-1===n&&(p.onDragover=ue,p.onDragleave=ie,p.onDrop=re),(0,_vue.h)("div",Object.assign({ref:g,class:["vxe-upload",{["size--"+r]:r,"is--active":u,"is--readonly":s,"is--disabled":d,"is--paste":o,"show--error":e,"is--drag":l}]},p),[(v?()=>{var{showList:e,dragSort:t}=C;const{fileList:o,isDragMove:a}=b,{maxCount:l,showMoreButton:i}=Y.value;let u=o,n=0;return l&&o.length>l&&(n=o.length-l,u=o.slice(0,l)),(0,_vue.h)("div",{key:"image",class:"vxe-upload--image-wrapper"},e?[t?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(a?"":"-disabled"),tag:"div",class:"vxe-upload--image-list"},{default:()=>z(u,!1).concat([i&&n?(0,_vue.h)("div",{key:"om",class:"vxe-upload--image-over-more"},[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[o.length]),status:"primary",onClick:x})]):(0,_vue.createCommentVNode)(),R(!1)])}):(0,_vue.h)("div",{class:"vxe-upload--image-list"},z(u,!1).concat([i&&n?(0,_vue.h)("div",{class:"vxe-upload--image-over-more"},[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[o.length]),status:"primary",onClick:x})]):(0,_vue.createCommentVNode)(),R(!1)]))]:[(0,_vue.h)("div",{class:"vxe-upload--image-list"},[R(!1)])])}:()=>{var{showList:e,moreConfig:t,dragSort:o}=C,{fileList:a,isDragMove:l}=b,{maxCount:i,showMoreButton:u,layout:n}=Y.value,n="horizontal"===n;let r=a,d=0;return i&&a.length>i&&(d=a.length-i,r=a.slice(0,i)),(0,_vue.h)("div",{key:"all",class:"vxe-upload--file-wrapper"},e?[u&&t&&n?(0,_vue.createCommentVNode)():k(!0),r.length||u&&n?(0,_vue.h)("div",{class:["vxe-upload--file-list-wrapper",{"is--horizontal":n}]},[r.length?o?(0,_vue.h)(_vue.TransitionGroup,{name:"vxe-upload--drag-list"+(l?"":"-disabled"),tag:"div",class:"vxe-upload--file-list"},{default:()=>F(r,!1)}):(0,_vue.h)("div",{class:"vxe-upload--file-list"},F(r,!1)):(0,_vue.createCommentVNode)(),u&&d?(0,_vue.h)("div",{class:"vxe-upload--file-over-more"},[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[a.length]),status:"primary",onClick:x})]):(0,_vue.createCommentVNode)(),u&&t&&n?k(!1):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)()]:[k(!1)])})(),a?(0,_vue.h)("div",{ref:c,class:"vxe-upload--drag-line"}):(0,_ui.renderEmptyElement)(h),l&&!i?(0,_vue.h)("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_ui.renderEmptyElement)(h)])},h},render(){return this.renderVN()}});