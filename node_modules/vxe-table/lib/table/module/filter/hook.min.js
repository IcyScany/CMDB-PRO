var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../../ui"),_util=require("../../src/util"),_dom=require("../../../ui/src/dom"),_utils=require("../../../ui/src/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let{renderer,hooks}=_ui.VxeUI,tableFilterMethodKeys=["openFilter","setFilter","clearFilter","saveFilterPanel","resetFilterPanel","getCheckedFilters","updateFilterOptionStatus"];hooks.add("tableFilterModule",{setupTable(k){let{props:d,reactData:f,internalData:o}=k,{refElem:u,refTableFilter:b}=k.getRefMaps(),{computeFilterOpts:h,computeMouseOpts:p}=k.getComputeMaps(),i=e=>{var t=f.filterStore;t.options.forEach(e=>{e.checked=e._checked}),k.confirmFilterEvent(e)},a=(e,t,l)=>{var r=f.filterStore;r.options.forEach(e=>{e._checked=!1}),l._checked=t,k.checkFilterOptions(),i(e)},n=(e,t,l)=>{l._checked=t,k.checkFilterOptions()},e=e=>{var t=f.filterStore;k.handleClearFilter(t.column),k.confirmFilterEvent(e)},s={checkFilterOptions(){var e=f.filterStore;e.isAllSelected=e.options.every(e=>e._checked),e.isIndeterminate=!e.isAllSelected&&e.options.some(e=>e._checked)},triggerFilterEvent(e,F,t){let{initStore:l,filterStore:_}=f,g=o.elemStore;if(_.column===F&&_.visible)_.visible=!1;else{let{clientY:d,pageX:f}=e,h=u.value,p=h.getBoundingClientRect(),v=e.target,m=(0,_dom.getDomNode)().visibleWidth;var{filters:i,filterMultiple:a,filterRender:n}=F,n=(0,_utils.isEnableConf)(n)?renderer.get(n.name):null;let r=F.filterRecoverMethod||(n?n.tableFilterRecoverMethod||n.filterRecoverMethod:null);o._currFilterParams=t,Object.assign(_,{multiple:a,options:i,column:F,style:null}),_.options.forEach(e=>{var{_checked:t,checked:l}=e;(e._checked=l)||t===l||r&&r({option:e,column:F,$table:k})}),this.checkFilterOptions(),_.visible=!0,l.filter=!0,(0,_vue.nextTick)(()=>{var l=(0,_util.getRefElem)(g["main-header-scroll"]);if(l){var r=b.value,r=r?r.$el:null;if(r){var i=r.offsetWidth,a=r.querySelector(".vxe-table--filter-header"),r=r.querySelector(".vxe-table--filter-footer"),n=i/2,o=h.clientWidth-i-10;let e,t;var u=v.offsetParent,s=u.offsetParent,c={top:v.offsetTop+u.offsetTop+v.offsetHeight+"px"},a=Math.max(40,h.clientHeight-(d-p.y)-(a?a.clientHeight:0)-(r?r.clientHeight:0)-14);"left"===F.fixed?e=v.offsetLeft+u.offsetLeft-n:"right"===F.fixed?t=u.offsetWidth-v.offsetLeft+(s.offsetWidth-s.offsetLeft)-F.renderWidth-n:e=v.offsetLeft+u.offsetLeft-n-l.scrollLeft,e?(0<(r=f+i-n+10-m)&&(e-=r),c.left=Math.min(o,Math.max(10,e))+"px"):t&&(0<(s=f+i-n+10-m)&&(t+=s),c.right=Math.max(10,t)+"px"),_.style=c,_.maxHeight=a}}})}k.dispatchEvent("filter-visible",{column:F,field:F.field,property:F.field,filterList:k.getCheckedFilters(),visible:_.visible},e)},handleClearFilter(e){if(e){var{filters:l,filterRender:r}=e;if(l){r=(0,_utils.isEnableConf)(r)?renderer.get(r.name):null;let t=e.filterResetMethod||(r?r.tableFilterResetMethod||r.filterResetMethod:null);l.forEach(e=>{e._checked=!1,e.checked=!1,t||(e.data=_xeUtils.default.clone(e.resetValue,!0))}),t&&t({options:l,column:e,$table:k})}}},handleColumnConfirmFilter(e,t){var l=d.mouseConfig;let{scrollXLoad:r,scrollYLoad:i}=f;var a=h.value,n=p.value,o=e.field;let u=[],s=[];e.filters.forEach(e=>{e.checked&&(u.push(e.value),s.push(e.data))});var c=k.getCheckedFilters(),e={$table:k,$event:t,column:e,field:o,property:o,values:u,datas:s,filters:c,filterList:c};return a.remote||(k.handleTableData(!0),k.checkSelectionStatus()),l&&n.area&&k.handleFilterEvent&&k.handleFilterEvent(t,e),t&&k.dispatchEvent("filter-change",e,t),k.closeFilter(),k.updateFooter().then(()=>{var{scrollXLoad:e,scrollYLoad:t}=f;if(r||e||i||t)return(r||e)&&k.updateScrollXSpace(),(i||t)&&k.updateScrollYSpace(),k.refreshScroll()}).then(()=>(k.updateCellAreas(),k.recalculate(!0))).then(()=>{setTimeout(()=>k.recalculate(),50)})},confirmFilterEvent(e){var t=f.filterStore,t=t.column;k.handleColumnConfirmFilter(t,e)},handleFilterChangeRadioOption:a,handleFilterChangeMultipleOption:n,handleFilterChangeOption(e,t,l){var r=f.filterStore;r.multiple?n(0,t,l):a(e,t,l)},handleFilterConfirmFilter:i,handleFilterResetFilter:e};return Object.assign(Object.assign({},{openFilter(e){let r=(0,_util.handleFieldOrColumn)(k,e);if(r&&r.filters){let t=o.elemStore,l=r.fixed;return k.scrollToColumn(r).then(()=>{var e=(0,_util.getRefElem)(t[`${l||"main"}-header-wrapper`]||t["main-header-wrapper"]);e&&(e=e.querySelector(`.vxe-header--column.${r.id} .vxe-filter--btn`),(0,_dom.triggerEvent)(e,"click"))})}return(0,_vue.nextTick)()},setFilter(e,t,l){e=(0,_util.handleFieldOrColumn)(k,e);return e&&e.filters&&(e.filters=(0,_util.toFilters)(t||[]),l)?k.handleColumnConfirmFilter(e,new Event("click")):(0,_vue.nextTick)()},clearFilter(e){var t=f.filterStore,l=o.tableFullColumn,r=h.value;let i;return e?(i=(0,_util.handleFieldOrColumn)(k,e))&&s.handleClearFilter(i):l.forEach(s.handleClearFilter),e&&i===t.column||Object.assign(t,{isAllSelected:!1,isIndeterminate:!1,style:null,options:[],column:null,multiple:!1,visible:!1}),r.remote?(0,_vue.nextTick)():k.updateData()},saveFilterPanel(){return i(null),(0,_vue.nextTick)()},resetFilterPanel(){return e(null),(0,_vue.nextTick)()},getCheckedFilters(){var e=o.tableFullColumn;let a=[];return e.forEach(e=>{var{field:t,filters:l}=e;let r=[],i=[];l&&l.length&&(l.forEach(e=>{e.checked&&(r.push(e.value),i.push(e.data))}),r.length)&&a.push({column:e,field:t,property:t,values:r,datas:i})}),a},updateFilterOptionStatus(e,t){return e._checked=t,e.checked=t,(0,_vue.nextTick)()}}),s)},setupGrid(e){return e.extendTableMethods(tableFilterMethodKeys)}});