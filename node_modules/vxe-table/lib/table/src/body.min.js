Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_util=require("./util"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_vn=require("../../ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let{getI18n,renderer,renderEmptyElement}=_ui.VxeUI,renderType="body";var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,fixedType:{type:String,default:""}},setup(T){let He=(0,_vue.inject)("$xeTable",{}),{xID:z,props:Le,context:q,reactData:je,internalData:Ne}=He,{computeEditOpts:Be,computeMouseOpts:We,computeCellOffsetWidth:Ge,computeAreaOpts:Pe,computeDefaultRowHeight:Ke,computeEmptyOpts:A,computeTooltipOpts:Xe,computeRadioOpts:e,computeExpandOpts:le,computeTreeOpts:v,computeCheckboxOpts:Ve,computeCellOpts:Ye,computeValidOpts:Je,computeRowOpts:Qe,computeColumnOpts:Ze,computeRowDragOpts:el,computeColumnDragOpts:l,computeResizableOpts:ll}=He.getComputeMaps(),$=(0,_vue.ref)(),U=(0,_vue.ref)(),F=(0,_vue.ref)(),H=(0,_vue.ref)(),L=(0,_vue.ref)(),j=(0,_vue.ref)(),N=(0,_vue.ref)(),B=(0,_vue.ref)(),tl=()=>{var e=Le.delayHover,{lastScrollTime:l,isDragResize:t}=je;return!!(t||l&&Date.now()<l+e)},al=(e,l,t)=>{var{row:a,column:r}=l,o=Ne.afterFullData,i=Le.treeConfig,s=v.value,{slots:r,treeNode:n}=r,d=Ne.fullAllDataRowIdData;if(r&&r.line)return He.callSlot(r.line,l);r=d[e];let u=0,c=null;r&&(u=r.level,c=r.items[r.treeIndex-1]);d=He.eqRow(o[0],a);return i&&n&&(s.showLine||s.line)?[(0,_vue.h)("div",{key:"tl",class:"vxe-tree--line-wrapper"},[(0,_vue.h)("div",{class:"vxe-tree--line",style:{height:`${d?1:(0,_util.calcTreeLine)(l,c)}px`,bottom:`-${Math.floor(t/2)}px`,left:u*s.indent+(u?2-(0,_util.getOffsetSize)(He):0)+16+"px"}})])]:[]},ae=($,e,l,U,F,t,a,H,r,o,L,j,i)=>{var s=He.xeGrid,{fullAllDataRowIdData:n,fullColumnIdData:d,visibleColumn:N}=Ne,{columnKey:B,resizable:u,showOverflow:c,border:W,height:v,cellClassName:G,cellStyle:P,align:K,spanMethod:X,mouseConfig:V,editConfig:Y,editRules:p,tooltipConfig:g,padding:h}=Le,{tableData:x,dragRow:J,overflowX:Q,currentColumn:Z,scrollXLoad:ee,scrollYLoad:w,calcCellHeightFlag:m,resizeHeightFlag:_,resizeWidthFlag:le,mergeList:te,editStore:ae,isAllOverflow:re,validErrorMaps:f}=je,{afterFullData:oe,scrollXStore:ie,scrollYStore:se}=Ne,ne=Ye.value,b=Je.value,de=Ve.value,ue=Be.value,y=Xe.value,{isAllColumnDrag:ce,isAllRowDrag:ve}=ll.value,C=Qe.value,D=el.value,pe=Ke.value,m=m?ne.height||C.height:0,{disabledMethod:R,isCrossDrag:ge,isPeerDrag:he}=D,xe=Ze.value,we=We.value,me=Pe.value,_e=Ge.value,me=me.selectCellToRow,{type:fe,cellRender:be,editRender:ye,align:Ce,showOverflow:De,className:Re,treeNode:Ee,rowResize:Oe,padding:E,verticalAlign:O,slots:Me}=o,M=ne.verticalAlign,ae=ae.actived,n=n[e]||{},S=o.id,d=d[S]||{},I=ye||be,I=I?renderer.get(I.name):null,Se=I?I.tableCellClassName||I.cellClassName:null,Ie=I?I.tableCellStyle||I.cellStyle:"";let ke=y.showAll;var Te=d.index,y=d._index,d=(0,_utils.isEnableConf)(ye),_=_?n.resizeHeight:0;let k=l?o.fixed!==l:o.fixed&&Q;Q=_xeUtils.default.eqNull(E)?null===h?ne.padding:h:E,h=_xeUtils.default.eqNull(De)?c:De,E="ellipsis"===h;let T="title"===h,z=!0===h||"tooltip"===h;c=re||T||z||E,De=_xeUtils.default.isBoolean(o.resizable)?o.resizable:xe.resizable||u,h=!!m,u=0<_;let ze;m={},_=Ce||(I?I.tableCellAlign:"")||K,Ce=_xeUtils.default.eqNull(O)?M:O,I=f[e+":"+S],K=p&&b.showMessage&&("default"===b.message?v||1<x.length:"inline"===b.message),M={colid:S};let q={$table:He,$grid:s,isEdit:!1,seq:$,rowid:e,row:t,rowIndex:a,$rowIndex:H,_rowIndex:r,column:o,columnIndex:Te,$columnIndex:L,_columnIndex:y,fixed:l,type:renderType,isHidden:!!k,level:F,visibleData:oe,data:x,items:i},A=!1,qe=!1,Ae=((A=C.drag?"row"===D.trigger||o.dragSort&&"cell"===D.trigger:A)&&(qe=!(!R||!R(q))),(T||z||ke||g)&&(m.onMouseenter=e=>{tl()||(T?(0,_dom.updateCellTitle)(e.currentTarget,o):(z||ke)&&He.triggerBodyTooltipEvent(e,q),He.dispatchEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},q),e))}),(z||ke||g)&&(m.onMouseleave=e=>{tl()||((z||ke)&&He.handleTargetLeaveEvent(e),He.dispatchEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},q),e))}),(A||de.range||V)&&(m.onMousedown=e=>{He.triggerCellMousedownEvent(e,q)}),A&&(m.onMouseup=He.triggerCellMouseupEvent),m.onClick=e=>{He.triggerCellClickEvent(e,q)},!(m.onDblclick=e=>{He.triggerCellDblclickEvent(e,q)}));if(te.length){O=(0,_util.mergeBodyMethod)(te,r,y);if(O){var{rowspan:f,colspan:p}=O;if(!f||!p)return null;1<f&&(Ae=!0,M.rowspan=f),1<p&&(Ae=!0,M.colspan=p)}}else if(X){var{rowspan:v=1,colspan:s=1}=X(q)||{};if(!v||!s)return null;1<v&&(M.rowspan=v),1<s&&(M.colspan=s)}!(k=k&&te&&(1<M.colspan||1<M.rowspan)?!1:k)&&Y&&(ye||be)&&(ue.showStatus||ue.showUpdateStatus)&&(ze=He.isUpdateByRow(t,o.field));$=w&&!c,a=n.resizeHeight||ne.height||C.height||n.height||pe,H=L===j.length-1,oe=!o.resizeWidth&&("auto"===o.minWidth||"auto"===o.width);let $e=!1;Ae||J&&(0,_util.getRowid)(He,J)===e||(w&&(r<se.visibleStartIndex-se.preloadSize||r>se.visibleEndIndex+se.preloadSize)||ee&&!o.fixed&&(y<ie.visibleStartIndex-ie.preloadSize||y>ie.visibleEndIndex+ie.preloadSize))&&($e=!0);x={};if(c&&le){let l=M.colspan||0;if(1<l)for(let e=1;e<l;e++){var Ue=N[Te+e];Ue&&(l+=Ue.renderWidth)}x.width=o.renderWidth-_e*l+"px"}w||c||h||u?x.height=a+"px":x.minHeight=a+"px";i=[];k&&re?i.push((0,_vue.h)("div",{key:"tc",class:["vxe-cell",{"c--title":T,"c--tooltip":z,"c--ellipsis":E}],style:x})):(i.push(...al(e,q,a),(0,_vue.h)("div",{key:"tc",class:["vxe-cell",{"c--title":T,"c--tooltip":z,"c--ellipsis":E}],style:x,title:T?He.getCellLabel(t,o):null},$e?[]:[(0,_vue.h)("div",{colid:S,rowid:e,class:"vxe-cell--wrapper"},o.renderCell(q))])),K&&I&&(D=I.rule,R=Me?Me.valid:null,g=Object.assign(Object.assign(Object.assign({},q),I),{rule:I}),i.push((0,_vue.h)("div",{key:"tcv",class:["vxe-cell--valid-error-tip",(0,_dom.getPropClass)(b.className,g)],style:D&&D.maxWidth?{width:D.maxWidth+"px"}:null},[(0,_vue.h)("div",{class:"vxe-cell--valid-error-wrapper vxe-cell--valid-error-theme-"+(b.theme||"normal")},[R?He.callSlot(R,g):[(0,_vue.h)("span",{class:"vxe-cell--valid-error-msg"},I.content)]])]))));let Fe=!1;return V&&we.area&&me&&((y||!0!==me)&&me!==o.field||(Fe=!0)),!k&&De&&ce&&i.push((0,_vue.h)("div",{key:"tcc",class:["vxe-cell--col-resizable",{"is--line":!W||"none"===W}],onMousedown:e=>He.handleColResizeMousedownEvent(e,l,q),onDblclick:e=>He.handleColResizeDblclickEvent(e,q)})),(Oe||ve)&&C.resizable&&i.push((0,_vue.h)("div",{key:"tcr",class:"vxe-cell--row-resizable",onMousedown:e=>He.handleRowResizeMousedownEvent(e,q),onDblclick:e=>He.handleRowResizeDblclickEvent(e,q)})),(0,_vue.h)("td",Object.assign(Object.assign(Object.assign({class:["vxe-body--column",S,Ce?"col--vertical-"+Ce:"",_?"col--"+_:"",fe?"col--"+fe:"",{"col--last":H,"col--tree-node":Ee,"col--edit":d,"col--ellipsis":c,"col--cs-height":h,"col--rs-height":u,"col--to-row":Fe,"col--auto-height":$,"fixed--width":!oe,"fixed--hidden":k,"is--padding":Q,"is--progress":k&&re||$e,"is--drag-cell":A&&(ge||he||!F),"is--drag-disabled":qe,"col--dirty":ze,"col--active":Y&&d&&ae.row===t&&(ae.column===o||"row"===ue.mode),"col--valid-error":!!I,"col--current":Z===o},(0,_dom.getPropClass)(Se,q),(0,_dom.getPropClass)(Re,q),(0,_dom.getPropClass)(G,q)],key:B||ee||w||xe.useKey||C.useKey||xe.drag?S:L},M),{style:Object.assign({},_xeUtils.default.isFunction(Ie)?Ie(q):Ie,_xeUtils.default.isFunction(P)?P(q):P)}),m),U&&k?[]:i)},te=(x,w,m,_)=>{let{stripe:f,rowKey:b,highlightHoverRow:y,rowClassName:C,rowStyle:D,editConfig:R,treeConfig:E}=Le,{hasFixedColumn:O,treeExpandedFlag:M,isColLoading:S,scrollXLoad:I,scrollYLoad:k,isAllOverflow:T,rowExpandedFlag:z,expandColumn:q,selectRadioRow:A,pendingRowFlag:$,isDragColMove:U,rowExpandHeightFlag:F}=je,{fullAllDataRowIdData:H,treeExpandedMaps:L,pendingRowMaps:j,rowExpandedMaps:N}=Ne,B=Ve.value,W=e.value,G=v.value,P=Be.value,K=Qe.value,X=Ze.value,V=l.value,{transform:Y,seqMode:Q}=G,Z=G.children||G.childrenField,J=[],ee=(0,_util.createHandleGetRowId)(He).handleGetRowId;return m.forEach((t,a)=>{let r=ee(t);var e=H[r]||{};let o=a,i=0,s=-1,n=-1;var l={},d=((K.isHover||y)&&(l.onMouseenter=e=>{tl()||He.triggerHoverEvent(e,{row:t,rowIndex:o})},l.onMouseleave=()=>{tl()||He.clearHoverRow()}),e&&(i=e.level,s=E&&Y&&"increasing"===Q?e._index+1:e.seq,o=e.index,n=e._index),{$table:He,seq:s,rowid:r,fixed:x,type:renderType,level:i,row:t,rowIndex:o,$rowIndex:a,_rowIndex:n}),u=q&&!!z&&!!N[r];let c=!1,v=[],p=!1;R&&(p=He.isInsertByRow(t)),!E||k||Y||(v=t[Z],c=!!M&&v&&0<v.length&&!!L[r]),!K.drag||E&&!Y||(l.onDragstart=He.handleRowDragDragstartEvent,l.onDragend=He.handleRowDragDragendEvent,l.onDragover=He.handleRowDragDragoverEvent);var g=["vxe-body--row",E?"row--level-"+i:"",{"row--stripe":f&&(n+1)%2==0,"is--new":p,"is--expand-row":u,"is--expand-tree":c,"row--new":p&&(P.showStatus||P.showInsertStatus),"row--radio":W.highlight&&He.eqRow(A,t),"row--checked":B.highlight&&He.isCheckedByCheckboxRow(t),"row--pending":!!$&&!!j[r]},(0,_dom.getPropClass)(C,d)];let h=_.map((e,l)=>ae(s,r,x,w,i,t,o,a,n,e,l,_,m));J.push(!S&&X.drag&&V.animation?(0,_vue.h)(_vue.TransitionGroup,Object.assign({name:"vxe-header--col-list"+(U?"":"-disabled"),tag:"tr",class:g,rowid:r,style:D?_xeUtils.default.isFunction(D)?D(d):D:null,key:b||I||k||K.useKey||K.drag||X.drag||E?r:a},l),{default:()=>h}):(0,_vue.h)("tr",Object.assign({class:g,rowid:r,style:D?_xeUtils.default.isFunction(D)?D(d):D:null,key:b||I||k||K.useKey||K.drag||X.drag||E?r:a},l),h)),u&&({height:g,padding:d,mode:l}=le.value,"fixed"===l?J.push((0,_vue.h)("tr",{class:"vxe-body--row-expanded-place",key:"expand_"+r,rowid:r},[(0,_vue.h)("td",{class:"vxe-body--row-expanded-place-column",colspan:_.length,style:{height:`${F?e.expandHeight||g:0}px`}})])):(u={},l=(g&&(u.height=g+"px"),E&&(u.paddingLeft=i*G.indent+30+"px"),q).showOverflow,e=_xeUtils.default.isUndefined(l)||_xeUtils.default.isNull(l)?T:l,l={$table:He,seq:s,column:q,fixed:x,type:renderType,level:i,row:t,rowIndex:o,$rowIndex:a,_rowIndex:n},J.push((0,_vue.h)("tr",{class:["vxe-body--expanded-row",{"is--padding":d}],key:"expand_"+r},[(0,_vue.h)("td",{class:["vxe-body--expanded-column",{"fixed--hidden":x&&!O,"col--ellipsis":e}],colspan:_.length},[(0,_vue.h)("div",{class:["vxe-body--expanded-cell",{"is--ellipsis":g}],style:u},[q.renderData(l)])])])))),c&&J.push(...te(x,w,v,_))}),J};(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{var e=T.fixedType,l=Ne.elemStore,e=`${e||"main"}-body-`;l[e+"wrapper"]=$,l[e+"scroll"]=U,l[e+"table"]=F,l[e+"colgroup"]=H,l[e+"list"]=L,l[e+"xSpace"]=j,l[e+"ySpace"]=N,l[e+"emptyBlock"]=B})}),(0,_vue.onUnmounted)(()=>{var e=T.fixedType,l=Ne.elemStore,e=`${e||"main"}-body-`;l[e+"wrapper"]=null,l[e+"scroll"]=null,l[e+"table"]=null,l[e+"colgroup"]=null,l[e+"list"]=null,l[e+"xSpace"]=null,l[e+"ySpace"]=null,l[e+"emptyBlock"]=null});return()=>{var e=q.slots,l=He.xeGrid;let{fixedColumn:t,fixedType:a,tableColumn:r}=T;var{spanMethod:o,footerSpanMethod:i,mouseConfig:s}=Le,{isGroup:n,tableData:d,isRowLoading:u,isColLoading:c,overflowX:v,scrollXLoad:p,scrollYLoad:g,isAllOverflow:h,isDragRowMove:x,expandColumn:w,dragRow:m,dragCol:_}=je,{visibleColumn:f,fullAllDataRowIdData:b,fullColumnIdData:y}=Ne,C=Qe.value,D=A.value,R=We.value,E=el.value,O=le.value;let M=d,S=r,I=!1;!(p||g||h)||w&&"fixed"!==O.mode||o||i||(I=!0),c||!a&&v||(S=f),a&&I&&(S=t||[]),g&&m&&2<M.length&&(d=b[(0,_util.getRowid)(He,m)])&&(h=d._index,w=M[0],O=M[M.length-1],o=b[(0,_util.getRowid)(He,w)],i=b[(0,_util.getRowid)(He,O)],o)&&i&&(v=o._index,f=i._index,h<v?M=[m].concat(M):f<h&&(M=M.concat([m]))),a||n||p&&_&&2<S.length&&(g=y[_.id])&&(d=g._index,w=S[0],b=S[S.length-1],O=y[w.id],o=y[b.id],O)&&o&&(i=O._index,v=o._index,d<i?S=[_].concat(S):v<d&&(S=S.concat([_])));let k;f=e?e.empty:null,k=f?He.callSlot(f,{$table:He,$grid:l}):(m=(h=D.name?renderer.get(D.name):null)?h.renderTableEmpty||h.renderTableEmptyView||h.renderEmpty:null)?(0,_vn.getSlotVNs)(m(D,{$table:He})):Le.emptyText||getI18n("vxe.table.emptyText"),n={onScroll(e){He.triggerBodyScrollEvent(e,a)}};return(0,_vue.h)("div",{ref:$,class:["vxe-table--body-wrapper",a?`fixed-${a}--wrapper`:"body--wrapper"],xid:z},[(0,_vue.h)("div",Object.assign({ref:U,class:"vxe-table--body-inner-wrapper"},n),[a?renderEmptyElement(He):(0,_vue.h)("div",{ref:j,class:"vxe-body--x-space"}),(0,_vue.h)("div",{ref:N,class:"vxe-body--y-space"}),(0,_vue.h)("table",{ref:F,class:"vxe-table--body",xid:z,cellspacing:0,cellpadding:0,border:0},[(0,_vue.h)("colgroup",{ref:H},S.map((e,l)=>(0,_vue.h)("col",{name:e.id,key:l,style:{width:e.renderWidth+"px"}}))),!u&&!c&&C.drag&&E.animation?(0,_vue.h)(_vue.TransitionGroup,{ref:L,name:"vxe-body--row-list"+(x?"":"-disabled"),tag:"tbody"},{default:()=>te(a,I,M,S)}):(0,_vue.h)("tbody",{ref:L},te(a,I,M,S))]),(0,_vue.h)("div",{class:"vxe-table--checkbox-range"}),s&&R.area?(0,_vue.h)("div",{class:"vxe-table--cell-area"},[(0,_vue.h)("span",{class:"vxe-table--cell-main-area"},R.extension?[(0,_vue.h)("span",{class:"vxe-table--cell-main-area-btn",onMousedown(e){He.triggerCellAreaExtendMousedownEvent&&He.triggerCellAreaExtendMousedownEvent(e,{$table:He,fixed:a,type:renderType})}})]:[]),(0,_vue.h)("span",{class:"vxe-table--cell-copy-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-extend-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-multi-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-active-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-row-status-area"})]):renderEmptyElement(He),a?renderEmptyElement(He):(0,_vue.h)("div",{class:"vxe-table--empty-block",ref:B},[(0,_vue.h)("div",{class:"vxe-table--empty-content"},k)])])])}}});