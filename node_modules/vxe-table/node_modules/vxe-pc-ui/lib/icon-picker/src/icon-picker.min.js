"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_comp=require("../../ui/src/comp"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_vn=require("../../ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_comp.defineVxeComponent)({name:"VxeIconPicker",props:{modelValue:String,placeholder:String,clearable:Boolean,size:{type:String,default:()=>(0,_ui.getConfig)().iconPicker.size||(0,_ui.getConfig)().size},className:[String,Function],popupClassName:[String,Function],showIconTitle:{type:Boolean,default:()=>(0,_ui.getConfig)().iconPicker.showIconTitle},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},icons:Array,placement:String,transfer:{type:Boolean,default:null}},emits:["update:modelValue","change","clear","click"],setup(d,e){const t=e["emit"],l=(0,_vue.inject)("$xeModal",null),n=(0,_vue.inject)("$xeDrawer",null),u=(0,_vue.inject)("$xeTable",null),a=(0,_vue.inject)("$xeForm",null),o=(0,_vue.inject)("xeFormItemInfo",null);var i=_xeUtils.default.uniqueId();const p=(0,_ui.useSize)(d)["computeSize"],f=(0,_vue.reactive)({initialized:!1,selectIcon:""+(d.modelValue||""),panelIndex:0,panelStyle:{},panelPlacement:null,visiblePanel:!1,isAniVisible:!1,isActivated:!1}),r={},g=(0,_vue.ref)(),m=(0,_vue.ref)(),b=(0,_vue.ref)(),c={refElem:g},x={xID:i,props:d,context:e,reactData:f,getRefMaps:()=>c};const h=(0,_vue.computed)(()=>{var e=d["readonly"];return null===e?!!a&&a.props.readonly:e}),E=(0,_vue.computed)(()=>{var e=d["disabled"];return null===e?!!a&&a.props.disabled:e}),k=(0,_vue.computed)(()=>{var e=d["transfer"];if(null===e){var i=(0,_ui.getConfig)().iconPicker.transfer;if(_xeUtils.default.isBoolean(i))return i;if(u||l||n||a)return!0}return e}),P=(0,_vue.computed)(()=>{var e=d["placeholder"];return(e=e||(0,_ui.getConfig)().select.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.base.pleaseSelect")}),s=(0,_vue.computed)(()=>{let e=d["icons"];return(e=e&&e.length?e:(0,_ui.getConfig)().iconPicker.icons||[]).map(e=>_xeUtils.default.isString(e)?{title:e,icon:"vxe-icon-"+(""+(e||"")).replace(/^vxe-icon-/,"")}:{title:""+(e.title||""),icon:e.icon||"",iconRender:e.iconRender})}),I=(0,_vue.computed)(()=>{var e=s.value;return _xeUtils.default.chunk(e,4)}),T=(0,_vue.computed)(()=>{const i=f["selectIcon"];var e=s.value;return i?e.find(e=>e.icon===i):null}),v=()=>(0,_vue.nextTick)().then(()=>{var t=d["placement"],n=f["panelIndex"],u=g.value,a=b.value,e=k.value;if(a&&u){var o=u.offsetHeight,r=u.offsetWidth,c=a.offsetHeight,a=a.offsetWidth,n={zIndex:n},{boundingTop:u,boundingLeft:s,visibleHeight:v,visibleWidth:_}=(0,_dom.getAbsolutePos)(u);let l="bottom";if(e){let e=s,i=u+o;"top"===t?(l="top",i=u-c):t||(i+c+5>v&&(l="top",i=u-c),i<5&&(l="bottom",i=u+o)),e+a+5>_&&(e-=e+a+5-_),e<5&&(e=5),Object.assign(n,{left:e+"px",top:i+"px",minWidth:r+"px"})}else"top"===t?(l="top",n.bottom=o+"px"):t||v<u+o+c&&5<u-o-c&&(l="top",n.bottom=o+"px");return f.panelStyle=n,f.panelPlacement=l,(0,_vue.nextTick)()}}),_=()=>{var e=r["hpTimeout"];E.value||(e&&(clearTimeout(e),r.hpTimeout=void 0),f.initialized||(f.initialized=!0),f.isActivated=!0,f.isAniVisible=!0,setTimeout(()=>{f.visiblePanel=!0},10),f.panelIndex<(0,_utils.getLastZIndex)()&&(f.panelIndex=(0,_utils.nextZIndex)()),v())},A=()=>{f.visiblePanel=!1,r.hpTimeout=setTimeout(()=>{f.isAniVisible=!1},350)},y=(e,i)=>{(f.selectIcon=i)!==d.modelValue&&(t("update:modelValue",i),K("change",{value:i},e),a)&&o&&a.triggerItemEvent(e,o.itemConfig.field,i)},S=()=>{E.value||f.visiblePanel||_()},N=()=>{f.isActivated=!1},V=(e,i)=>{y(e,i),K("clear",{value:i},e)},C=(e,i)=>{V(i,null),A()},L=e=>{e.preventDefault(),(f.visiblePanel?A:_)()},O=e=>{L(e),K("click",{},e)},B=e=>{var i=f["visiblePanel"];E.value||i&&(i=b.value,((0,_dom.getEventTargetNode)(e,i).flag?v:A)())},R=e=>{var i,l,t=f["visiblePanel"];E.value||(i=g.value,l=b.value,f.isActivated=(0,_dom.getEventTargetNode)(e,i).flag||(0,_dom.getEventTargetNode)(e,l).flag,t&&!f.isActivated&&A())},w=e=>{var i,l,t,n,u,a,o,r=d["clearable"],c=f["visiblePanel"];E.value||(i=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.TAB),l=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ENTER),t=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ESCAPE),n=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),u=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),a=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.DELETE),o=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.SPACEBAR),i&&(f.isActivated=!1),c?t||i?A():l?(e.preventDefault(),e.stopPropagation()):(n||u||o)&&e.preventDefault():(n||u||l||o)&&f.isActivated&&(e.preventDefault(),_()),f.isActivated&&a&&r&&V(e,null))},z=()=>{var{visiblePanel:e,isActivated:i}=f;e&&A(),i&&(f.isActivated=!1),(e||i)&&(e=m.value)&&e.blur()},K=(e,i,l)=>{t(e,(0,_ui.createEvent)(l,{$iconPicker:x},i))},D=(i={dispatchEvent:K,isPanelVisible(){return f.visiblePanel},togglePanel(){return(f.visiblePanel?A:_)(),(0,_vue.nextTick)()},hidePanel(){return f.visiblePanel&&A(),(0,_vue.nextTick)()},showPanel(){return f.visiblePanel||_(),(0,_vue.nextTick)()},focus(){var e=m.value;return f.isActivated=!0,e&&e.blur(),(0,_vue.nextTick)()},blur(){var e=m.value;return e&&e.blur(),(f.isActivated=!1,_vue.nextTick)()}},(e,i)=>{i=i.icon;y(e,i),A()});Object.assign(x,i);return(0,_vue.watch)(()=>d.modelValue,e=>{f.selectIcon=""+(e||"")}),(0,_vue.onMounted)(()=>{_ui.globalEvents.on(x,"mousewheel",B),_ui.globalEvents.on(x,"mousedown",R),_ui.globalEvents.on(x,"keydown",w),_ui.globalEvents.on(x,"blur",z)}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(x,"mousewheel"),_ui.globalEvents.off(x,"mousedown"),_ui.globalEvents.off(x,"keydown"),_ui.globalEvents.off(x,"blur")}),(0,_vue.provide)("$xeIconPicker",x),x.renderVN=()=>{var{className:e,popupClassName:i,clearable:l}=d,{initialized:t,isActivated:n,isAniVisible:u,visiblePanel:a,selectIcon:o}=f,r=p.value,c=E.value,s=k.value,v=h.value,_=P.value;return v?(0,_vue.h)("div",{ref:g,class:["vxe-ico-picker--readonly",e]},[(0,_vue.h)("i",{class:o})]):(0,_vue.h)("div",{ref:g,class:["vxe-ico-picker",e?_xeUtils.default.isFunction(e)?e({$iconPicker:x}):e:"",{["size--"+r]:r,"show--clear":l&&!c&&!!o,"is--visible":a,"is--disabled":c,"is--active":n}]},[(0,_vue.h)("div",{class:"vxe-ico-picker--inner",onClick:O},[(0,_vue.h)("input",{ref:m,class:"vxe-ico-picker--input",onFocus:S,onBlur:N}),o?(()=>{var e=f["selectIcon"],i=T.value;if(i){var l=i["iconRender"],t=l?_ui.renderer.get(l.name):null,t=t?t.renderIconPickerOptionIcon:null;if(t&&l)return(0,_vue.h)("div",{key:"inc",class:"vxe-ico-picker--icon"},(0,_vn.getSlotVNs)(t(l,{$iconPicker:x,option:i})))}return(0,_vue.h)("div",{key:"ind",class:"vxe-ico-picker--icon"},[(0,_vue.h)("i",{class:e})])})():(0,_vue.h)("div",{class:"vxe-ico-picker--placeholder"},_),(0,_vue.h)("div",{class:"vxe-ico-picker--suffix"},[(0,_vue.h)("div",{class:"vxe-ico-picker--clear-icon",onClick:C},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().INPUT_CLEAR})]),(0,_vue.h)("div",{class:"vxe-ico-picker--suffix-icon"},[(0,_vue.h)("i",{class:a?(0,_ui.getIcon)().ICON_PICKER_OPEN:(0,_ui.getIcon)().ICON_PICKER_CLOSE})])])]),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!s||!t},[(0,_vue.h)("div",{ref:b,class:["vxe-table--ignore-clear vxe-ico-picker--panel",i?_xeUtils.default.isFunction(i)?i({$iconPicker:x}):i:"",{["size--"+r]:r,"is--transfer":s,"ani--leave":u,"ani--enter":a}],placement:f.panelPlacement,style:f.panelStyle},[t&&(a||u)?(0,_vue.h)("div",{class:"vxe-ico-picker--panel-wrapper"},[(()=>{const t=d["showIconTitle"];var e=I.value;const n=E.value;return(0,_vue.h)("div",{class:"vxe-ico-picker--list-wrapper"},e.map(e=>(0,_vue.h)("div",{class:"vxe-ico-picker--list"},e.map(i=>{var e=i["iconRender"],l=e?_ui.renderer.get(e.name):null,l=l?l.renderIconPickerOptionIcon:null;return(0,_vue.h)("div",{class:"vxe-ico-picker--item",onClick(e){n||D(e,i)}},[(0,_vue.h)("div",{class:"vxe-ico-picker--item-icon"},l&&e?(0,_vn.getSlotVNs)(l(e,{$iconPicker:x,option:i})):[(0,_vue.h)("i",{class:i.icon||""})]),t?(0,_vue.h)("div",{class:"vxe-ico-picker--item-title"},""+(i.title||"")):(0,_ui.renderEmptyElement)(x)])}))))})()]):(0,_ui.renderEmptyElement)(x)])])])},x},render(){return this.renderVN()}});